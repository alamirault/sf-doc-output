        
<!DOCTYPE html>
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head><base href="/">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
                                
    
    <link rel="stylesheet" href="assets/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/highlightjs.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/badge_only.css" type="text/css" />

</head>

<body class="wy-body-for-nav">
 <div class="wy-grid-for-nav">

        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">
                
                                                                                                    
                                                                                                                                                                        </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                                                                                                                                                                                                                                                                                                                            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

                                                        

        <div class="wy-nav-content">                <div class="rst-content">
                                        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">                            <div itemprop="articleBody">
                                    <div class="section">
<h1 id="messenger-sync-queued-message-handling">
    Messenger: Sync &amp; Queued Message Handling
    <a class="headerlink" href="#messenger-sync-queued-message-handling" title="Permalink to this headline">¶</a>
</h1>
<p>Messenger provides a message bus with the ability to send messages and then
handle them immediately in your application or send them through transports
(e.g. queues) to be handled later. To learn more deeply about it, read the
<a href="components/messenger.html" class="reference internal">Messenger component docs</a>.</p>
<div class="section">
<h2 id="installation">
    Installation
    <a class="headerlink" href="#installation" title="Permalink to this headline">¶</a>
</h2>
<p>In applications using <a href="setup.html#symfony-flex" class="reference internal">Symfony Flex</a>, run this command to
install messenger:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
<div class="section">
<h2 id="creating-a-message-handler">
    Creating a Message &amp; Handler
    <a class="headerlink" href="#creating-a-message-handler" title="Permalink to this headline">¶</a>
</h2>
<p>Messenger centers around two different classes that you'll create: (1) a message
class that holds data and (2) a handler(s) class that will be called when that
message is dispatched. The handler class will read the message class and perform
one or more tasks.</p>
<p>There are no specific requirements for a message class, except that it can be
serialized:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/Message/SmsNotification.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsNotification</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        private string <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>content</span>,
    )</span> </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getContent</span><span class="hljs-params">()</span>: <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>content;
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<span id="messenger-handler"></span>
<p>A message handler is a PHP callable, the recommended way to create it is to
create a class that has the <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Attribute/AsMessageHandler.php" class="reference external" title="Symfony\Component\Messenger\Attribute\AsMessageHandler" rel="external noopener noreferrer" target="_blank">AsMessageHandler</a>
attribute and has an <code translate="no" class="notranslate">__invoke()</code> method that's type-hinted with the
message class (or a message interface):</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/SmsNotificationHandler.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">SmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Attribute</span>\<span class="hljs-title">AsMessageHandler</span>;

<span class="hljs-comment">#[AsMessageHandler]</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsNotificationHandler</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(SmsNotification <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>)</span>
    </span>{
        <span class="hljs-comment">// ... do some work - like sending an SMS message!</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>You can also use the <code translate="no" class="notranslate">#[AsMessageHandler]</code> attribute on individual class
methods. You may use the attribute on as many methods in a single class as you
like, allowing you to group the handling of multiple related types of messages.</p>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>Support for <code translate="no" class="notranslate">#[AsMessageHandler]</code> on methods was introduced in Symfony 6.1.</p>
</div>
<p>Thanks to <a href="service_container.html#services-autoconfigure" class="reference internal">autoconfiguration</a> and the <code translate="no" class="notranslate">SmsNotification</code>
type-hint, Symfony knows that this handler should be called when an <code translate="no" class="notranslate">SmsNotification</code>
message is dispatched. Most of the time, this is all you need to do. But you can
also <a href="messenger.html#messenger-handler-config" class="reference internal">manually configure message handlers</a>. To
see all the configured handlers, run:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>php bin/console debug:messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
<div class="section">
<h2 id="dispatching-the-message">
    Dispatching the Message
    <a class="headerlink" href="#dispatching-the-message" title="Permalink to this headline">¶</a>
</h2>
<p>You're ready! To dispatch the message (and call the handler), inject the
<code translate="no" class="notranslate">messenger.default_bus</code> service (via the <code translate="no" class="notranslate">MessageBusInterface</code>), like in a controller:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/Controller/DefaultController.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">SmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Bundle</span>\<span class="hljs-title">FrameworkBundle</span>\<span class="hljs-title">Controller</span>\<span class="hljs-title">AbstractController</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">MessageBusInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractController</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(MessageBusInterface <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span>)</span>
    </span>{
        <span class="hljs-comment">// will cause the SmsNotificationHandler to be called</span>
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>dispatch(<span class="hljs-keyword">new</span> SmsNotification(<span class="hljs-string">'Look! I created a message!'</span>));

        <span class="hljs-comment">// ...</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
<div class="section">
<h2 id="transports-async-queued-messages">
    Transports: Async/Queued Messages
    <a class="headerlink" href="#transports-async-queued-messages" title="Permalink to this headline">¶</a>
</h2>
<p>By default, messages are handled as soon as they are dispatched. If you want
to handle a message asynchronously, you can configure a transport. A transport
is capable of sending messages (e.g. to a queueing system) and then
<a href="messenger.html#messenger-worker" class="reference internal">receiving them via a worker</a>. Messenger supports
<a href="messenger.html#messenger-transports-config" class="reference internal">multiple transports</a>.</p>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>If you want to use a transport that's not supported, check out the
<a href="https://github.com/sroze/messenger-enqueue-transport" class="reference external" rel="external noopener noreferrer" target="_blank">Enqueue's transport</a>, which supports things like Kafka and Google Pub/Sub.</p>
</div>
<p>A transport is registered using a &quot;DSN&quot;. Thanks to Messenger's Flex recipe, your
<code translate="no" class="notranslate">.env</code> file already has a few examples.</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># MESSENGER_TRANSPORT_DSN=amqp://guest:guest@localhost:5672/%2f/messages</span>
<span class="hljs-comment"># MESSENGER_TRANSPORT_DSN=doctrine://default</span>
<span class="hljs-comment"># MESSENGER_TRANSPORT_DSN=redis://localhost:6379/messages</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Uncomment whichever transport you want (or set it in <code translate="no" class="notranslate">.env.local</code>). See
<a href="messenger.html#messenger-transports-config" class="reference internal">Messenger: Sync &amp; Queued Message Handling</a> for more details.</p>
<p>Next, in <code translate="no" class="notranslate">config/packages/messenger.yaml</code>, let's define a transport called <code translate="no" class="notranslate">async</code>
that uses this configuration:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-3899fa8c95b335d5dac30fbf71bf36673d43c57a" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-95ab3bb91938f7324d8a81f12af855cb53159143" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-18acd34e452f80e265d5c0b96aa395f93516e721" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-3899fa8c95b335d5dac30fbf71bf36673d43c57a" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async:</span> <span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>

            <span class="hljs-comment"># or expanded to configure more options</span>
            <span class="hljs-comment">#async:</span>
            <span class="hljs-comment">#    dsn: "%env(MESSENGER_TRANSPORT_DSN)%"</span>
            <span class="hljs-comment">#    options: []</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-95ab3bb91938f7324d8a81f12af855cb53159143" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async"</span>&gt;</span>%env(MESSENGER_TRANSPORT_DSN)%<span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>

            <span class="hljs-comment">&lt;!-- or expanded to configure more options --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async"</span>
                <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>
            &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"..."</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-18acd34e452f80e265d5c0b96aa395f93516e721" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger()
        <span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async'</span>)
            <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
    ;

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger()
        <span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async'</span>)
            <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
            <span class="hljs-operator">-&gt;</span>options([])
    ;
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<span id="messenger-routing"></span>
<div class="section">
<h3 id="routing-messages-to-a-transport">
    Routing Messages to a Transport
    <a class="headerlink" href="#routing-messages-to-a-transport" title="Permalink to this headline">¶</a>
</h3>
<p>Now that you have a transport configured, instead of handling a message immediately,
you can configure them to be sent to a transport:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-4ea8664584c405b1eef703cc4e42ddd078b02f1f" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-b3021e8d192f56e83cd83d5c5271852b92c0658a" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-a84c251b4eec5abb90e03a6332ae1300a21a48e3" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-4ea8664584c405b1eef703cc4e42ddd078b02f1f" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async:</span> <span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>

        <span class="hljs-attr">routing:</span>
            <span class="hljs-comment"># async is whatever name you gave your transport above</span>
            <span class="hljs-string">'App\Message\SmsNotification'</span><span class="hljs-string">:</span> <span class="hljs-string">async</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-b3021e8d192f56e83cd83d5c5271852b92c0658a" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\SmsNotification"</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- async is whatever name you gave your transport above --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-a84c251b4eec5abb90e03a6332ae1300a21a48e3" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger()
        <span class="hljs-comment">// async is whatever name you gave your transport above</span>
        <span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\SmsNotification'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async'</span>])
    ;
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>Thanks to this, the <code translate="no" class="notranslate">App\Message\SmsNotification</code> will be sent to the <code translate="no" class="notranslate">async</code>
transport and its handler(s) will <em>not</em> be called immediately. Any messages not
matched under <code translate="no" class="notranslate">routing</code> will still be handled immediately, i.e. synchronously.</p>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>You may use <code translate="no" class="notranslate">&#039;*&#039;</code> as the message class. This will act as a default routing
rule for any message not matched under <code translate="no" class="notranslate">routing</code>. This is useful to ensure
no message is handled synchronously by default.</p>
<p>The only drawback is that <code translate="no" class="notranslate">&#039;*&#039;</code> will also apply to the emails sent with the
Symfony Mailer (which uses <code translate="no" class="notranslate">SendEmailMessage</code> when Messenger is available).
This could cause issues if your emails are not serializable (e.g. if they include
file attachments as PHP resources/streams).</p>
</div>
<p>You can also route classes by their parent class or interface. Or send messages
to multiple transports:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-75d84abbb9afaad709b27128a2bc017006bc03cc" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-6ece463778123532d22481c502a50ecdbc722a27" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-2a3cf970ad031a0dd1917b1c214cb9d4fd3cd37d" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-75d84abbb9afaad709b27128a2bc017006bc03cc" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">routing:</span>
            <span class="hljs-comment"># route all messages that extend this example base class or interface</span>
            <span class="hljs-string">'App\Message\AbstractAsyncMessage'</span><span class="hljs-string">:</span> <span class="hljs-string">async</span>
            <span class="hljs-string">'App\Message\AsyncMessageInterface'</span><span class="hljs-string">:</span> <span class="hljs-string">async</span>

            <span class="hljs-string">'My\Message\ToBeSentToTwoSenders'</span><span class="hljs-string">:</span> <span class="hljs-string">[async,</span> <span class="hljs-string">audit]</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-6ece463778123532d22481c502a50ecdbc722a27" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- route all messages that extend this example base class or interface --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\AbstractAsyncMessage"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\AsyncMessageInterface"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"My\Message\ToBeSentToTwoSenders"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"audit"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-2a3cf970ad031a0dd1917b1c214cb9d4fd3cd37d" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();
    <span class="hljs-comment">// route all messages that extend this example base class or interface</span>
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\AbstractAsyncMessage'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async'</span>]);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\AsyncMessageInterface'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async'</span>]);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'My\Message\ToBeSentToTwoSenders'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async'</span>, <span class="hljs-string">'audit'</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>If you configure routing for both a child and parent class, both rules
are used. E.g. if you have an <code translate="no" class="notranslate">SmsNotification</code> object that extends
from <code translate="no" class="notranslate">Notification</code>, both the routing for <code translate="no" class="notranslate">Notification</code> and
<code translate="no" class="notranslate">SmsNotification</code> will be used.</p>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>You can define and override the transport that a message is using at
runtime by using the
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Stamp/TransportNamesStamp.php" class="reference external" title="Symfony\Component\Messenger\Stamp\TransportNamesStamp" rel="external noopener noreferrer" target="_blank">TransportNamesStamp</a> on
the envelope of the message. This stamp takes an array of transport
name as its only argument. For more information about stamps, see
<a href="messenger.html#envelopes-stamps" class="reference internal">Envelopes &amp; Stamps</a>.</p>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.2</span>
    </p><p>The <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Stamp/TransportNamesStamp.php" class="reference external" title="Symfony\Component\Messenger\Stamp\TransportNamesStamp" rel="external noopener noreferrer" target="_blank">TransportNamesStamp</a>
stamp was introduced in Symfony 6.2.</p>
</div>
</div>
<div class="section">
<h3 id="doctrine-entities-in-messages">
    Doctrine Entities in Messages
    <a class="headerlink" href="#doctrine-entities-in-messages" title="Permalink to this headline">¶</a>
</h3>
<p>If you need to pass a Doctrine entity in a message, it's better to pass the entity's
primary key (or whatever relevant information the handler actually needs, like <code translate="no" class="notranslate">email</code>,
etc.) instead of the object (otherwise you might see errors related to the Entity Manager):</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/Message/NewUserWelcomeEmail.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewUserWelcomeEmail</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        private int <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>userId</span>,
    )</span> </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUserId</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>userId;
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Then, in your handler, you can query for a fresh object:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/NewUserWelcomeEmailHandler.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">NewUserWelcomeEmail</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Repository</span>\<span class="hljs-title">UserRepository</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Attribute</span>\<span class="hljs-title">AsMessageHandler</span>;

<span class="hljs-comment">#[AsMessageHandler]</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewUserWelcomeEmailHandler</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        private UserRepository <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>userRepository</span>,
    )</span> </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(NewUserWelcomeEmail <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>welcomeEmail</span>)</span>
    </span>{
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>user</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>userRepository<span class="hljs-operator">-&gt;</span>find(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>welcomeEmail</span><span class="hljs-operator">-&gt;</span>getUserId());

        <span class="hljs-comment">// ... send an email!</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>This guarantees the entity contains fresh data.</p>
</div>
<div class="section">
<h3 id="handling-messages-synchronously">
    Handling Messages Synchronously
    <a class="headerlink" href="#handling-messages-synchronously" title="Permalink to this headline">¶</a>
</h3>
<p>If a message doesn't <a href="messenger.html#messenger-routing" class="reference internal">match any routing rules</a>, it won't
be sent to any transport and will be handled immediately. In some cases (like
when <a href="messenger.html#binding-handlers-to-different-transports" class="reference internal">binding handlers to different transports</a>),
it's easier or more flexible to handle this explicitly: by creating a <code translate="no" class="notranslate">sync</code>
transport and &quot;sending&quot; messages there to be handled immediately:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-26c02fdeb5e0481c30123d28b6cca77299bf8fb4" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-f9aa8de1daadaf06c1b5c956bba300f2b7206d45" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-b025a5403b8ff694796fcc1c61883903b2353b50" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-26c02fdeb5e0481c30123d28b6cca77299bf8fb4" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-comment"># ... other transports</span>

            <span class="hljs-attr">sync:</span> <span class="hljs-string">'sync://'</span>

        <span class="hljs-attr">routing:</span>
            <span class="hljs-string">App\Message\SmsNotification:</span> <span class="hljs-string">sync</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-f9aa8de1daadaf06c1b5c956bba300f2b7206d45" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- ... other transports --&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sync"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"sync://"</span>/&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\SmsNotification"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"sync"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-b025a5403b8ff694796fcc1c61883903b2353b50" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-comment">// ... other transports</span>

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'sync'</span>)<span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'sync://'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\SmsNotification'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'sync'</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
</div>
<div class="section">
<h3 id="creating-your-own-transport">
    Creating your Own Transport
    <a class="headerlink" href="#creating-your-own-transport" title="Permalink to this headline">¶</a>
</h3>
<p>You can also create your own transport if you need to send or receive messages
from something that is not supported. See <a href="messenger/custom-transport.html" class="reference internal">How to Create Your own Messenger Transport</a>.</p>
<span id="messenger-worker"></span>
</div>
</div>
<div class="section">
<h2 id="consuming-messages-running-the-worker">
    Consuming Messages (Running the Worker)
    <a class="headerlink" href="#consuming-messages-running-the-worker" title="Permalink to this headline">¶</a>
</h2>
<p>Once your messages have been routed, in most cases, you'll need to &quot;consume&quot; them.
You can do this with the <code translate="no" class="notranslate">messenger:consume</code> command:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>php bin/console messenger:consume async

<span class="hljs-comment"># use -vv to see details about what's happening</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:consume async -vv</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The first argument is the receiver's name (or service id if you routed to a
custom service). By default, the command will run forever: looking for new messages
on your transport and handling them. This command is called your &quot;worker&quot;.</p>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>To properly stop a worker, throw an instance of
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Exception/StopWorkerException.php" class="reference external" title="Symfony\Component\Messenger\Exception\StopWorkerException" rel="external noopener noreferrer" target="_blank">StopWorkerException</a>.</p>
</div>
<div class="section">
<h3 id="deploying-to-production">
    Deploying to Production
    <a class="headerlink" href="#deploying-to-production" title="Permalink to this headline">¶</a>
</h3>
<p>On production, there are a few important things to think about:</p>
<dl>
                        <dt><strong>Use a Process Manager like Supervisor or systemd to keep your worker(s) running</strong></dt>
        
        <dd>
                            You'll want one or more &quot;workers&quot; running at all times. To do that, use a
process control system like <a href="messenger.html#messenger-supervisor" class="reference internal">Supervisor</a>
or <a href="messenger.html#messenger-systemd" class="reference internal">systemd</a>.
                    </dd>
                        <dt><strong>Don't Let Workers Run Forever</strong></dt>
        
        <dd>
                            Some services (like Doctrine's <code translate="no" class="notranslate">EntityManager</code>) will consume more memory
over time. So, instead of allowing your worker to run forever, use a flag
like <code translate="no" class="notranslate">messenger:consume --limit=10</code> to tell your worker to only handle 10
messages before exiting (then the process manager will create a new process). There
are also other options like <code translate="no" class="notranslate">--memory-limit=128M</code> and <code translate="no" class="notranslate">--time-limit=3600</code>.
                    </dd>
                        <dt><strong>Stopping Workers That Encounter Errors</strong></dt>
        
        <dd>
                            If a worker dependency like your database server is down, or timeout is reached,
you can try to add <a href="messenger.html#middleware-doctrine" class="reference internal">reconnect logic</a>, or just quit
the worker if it receives too many errors with the <code translate="no" class="notranslate">--failure-limit</code> option of
the <code translate="no" class="notranslate">messenger:consume</code> command.
                    </dd>
                        <dt><strong>Restart Workers on Deploy</strong></dt>
        
        <dd>
                            Each time you deploy, you'll need to restart all your worker processes so
that they see the newly deployed code. To do this, run <code translate="no" class="notranslate">messenger:stop-workers</code>
on deployment. This will signal to each worker that it should finish the message
it's currently handling and should shut down gracefully. Then, the process manager
will create new worker processes. The command uses the <a href="cache.html#cache-configuration-with-frameworkbundle" class="reference internal">app</a>
cache internally - so make sure this is configured to use an adapter you like.
                    </dd>
                        <dt><strong>Use the Same Cache Between Deploys</strong></dt>
        
        <dd>
                            If your deploy strategy involves the creation of new target directories, you
should set a value for the <a href="reference/configuration/framework.html#reference-cache-prefix-seed" class="reference internal">cache.prefix.seed</a>
configuration option in order to use the same cache namespace between deployments.
Otherwise, the <code translate="no" class="notranslate">cache.app</code> pool will use the value of the <code translate="no" class="notranslate">kernel.project_dir</code>
parameter as base for the namespace, which will lead to different namespaces
each time a new deployment is made.
                    </dd>
    </dl>
</div>
<div class="section">
<h3 id="prioritized-transports">
    Prioritized Transports
    <a class="headerlink" href="#prioritized-transports" title="Permalink to this headline">¶</a>
</h3>
<p>Sometimes certain types of messages should have a higher priority and be handled
before others. To make this possible, you can create multiple transports and route
different messages to them. For example:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-253286ac6859763d48ab1921ffa7ca62c4e88fde" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-d568afc24dae25399bcf7e0a7a2600688c81f89e" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-162e2fcf1bda3202afbd811980092297c0ffd372" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-253286ac6859763d48ab1921ffa7ca62c4e88fde" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_high:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">'%env(MESSENGER_TRANSPORT_DSN)%'</span>
                <span class="hljs-attr">options:</span>
                    <span class="hljs-comment"># queue_name is specific to the doctrine transport</span>
                    <span class="hljs-attr">queue_name:</span> <span class="hljs-string">high</span>

                    <span class="hljs-comment"># for AMQP send to a separate exchange then queue</span>
                    <span class="hljs-comment">#exchange:</span>
                    <span class="hljs-comment">#    name: high</span>
                    <span class="hljs-comment">#queues:</span>
                    <span class="hljs-comment">#    messages_high: ~</span>
                    <span class="hljs-comment"># or redis try "group"</span>
            <span class="hljs-attr">async_priority_low:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">'%env(MESSENGER_TRANSPORT_DSN)%'</span>
                <span class="hljs-attr">options:</span>
                    <span class="hljs-attr">queue_name:</span> <span class="hljs-string">low</span>

        <span class="hljs-attr">routing:</span>
            <span class="hljs-string">'App\Message\SmsNotification'</span><span class="hljs-string">:</span> <span class="hljs-string">async_priority_low</span>
            <span class="hljs-string">'App\Message\NewUserWelcomeEmail'</span><span class="hljs-string">:</span> <span class="hljs-string">async_priority_high</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-d568afc24dae25399bcf7e0a7a2600688c81f89e" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_high"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:options</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">framework:queue</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">framework:name</span>&gt;</span>Queue<span class="hljs-tag">&lt;/<span class="hljs-name">framework:name</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:queue</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">framework:options</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_low"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"queue_name"</span>&gt;</span>low<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\SmsNotification"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async_priority_low"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\NewUserWelcomeEmail"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async_priority_high"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-162e2fcf1bda3202afbd811980092297c0ffd372" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_high'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
        <span class="hljs-operator">-&gt;</span>options([<span class="hljs-string">'queue_name'</span> =&gt; <span class="hljs-string">'high'</span>]);

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_low'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
        <span class="hljs-operator">-&gt;</span>options([<span class="hljs-string">'queue_name'</span> =&gt; <span class="hljs-string">'low'</span>]);

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\SmsNotification'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async_priority_low'</span>]);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\NewUserWelcomeEmail'</span>)<span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'async_priority_high'</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>You can then run individual workers for each transport or instruct one worker
to handle messages in a priority order:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>php bin/console messenger:consume async_priority_high async_priority_low</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The worker will always first look for messages waiting on <code translate="no" class="notranslate">async_priority_high</code>. If
there are none, <em>then</em> it will consume messages from <code translate="no" class="notranslate">async_priority_low</code>.</p>
<span id="messenger-limit-queues"></span>
</div>
<div class="section">
<h3 id="limit-consuming-to-specific-queues">
    Limit Consuming to Specific Queues
    <a class="headerlink" href="#limit-consuming-to-specific-queues" title="Permalink to this headline">¶</a>
</h3>
<p>Some transports (notably AMQP) have the concept of exchanges and queues. A Symfony
transport is always bound to an exchange. By default, the worker consumes from all
queues attached to the exchange of the specified transport. However, there are use
cases to want a worker to only consume from specific queues.</p>
<p>You can limit the worker to only process messages from specific queue(s):</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>php bin/console messenger:consume my_transport --queues=fasttrack

<span class="hljs-comment"># you can pass the --queues option more than once to process multiple queues</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:consume my_transport --queues=fasttrack1 --queues=fasttrack2</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>To allow using the <code translate="no" class="notranslate">queues</code> option, the receiver must implement the
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Transport/Receiver/QueueReceiverInterface.php" class="reference external" title="Symfony\Component\Messenger\Transport\Receiver\QueueReceiverInterface" rel="external noopener noreferrer" target="_blank">QueueReceiverInterface</a>.</p>
</div>
<span id="messenger-message-count"></span>
</div>
<div class="section">
<h3 id="checking-the-number-of-queued-messages-per-transport">
    Checking the Number of Queued Messages Per Transport
    <a class="headerlink" href="#checking-the-number-of-queued-messages-per-transport" title="Permalink to this headline">¶</a>
</h3>
<p>Run the <code translate="no" class="notranslate">messenger:stats</code> command to know how many messages are in the &quot;queues&quot;
of some or all transports:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-comment"># displays the number of queued messages in all transports</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:stats

<span class="hljs-comment"># shows stats only for some transports</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:stats my_transport_name other_transport_name</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>In order for this command to work, the configured transport's receiver must implement
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Transport/Receiver/MessageCountAwareInterface.php" class="reference external" title="Symfony\Component\Messenger\Transport\Receiver\MessageCountAwareInterface" rel="external noopener noreferrer" target="_blank">MessageCountAwareInterface</a>.</p>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.2</span>
    </p><p>The <code translate="no" class="notranslate">messenger:stats</code> command was introduced in Symfony 6.2.</p>
</div>
<span id="messenger-supervisor"></span>
</div>
<div class="section">
<h3 id="supervisor-configuration">
    Supervisor Configuration
    <a class="headerlink" href="#supervisor-configuration" title="Permalink to this headline">¶</a>
</h3>
<p>Supervisor is a great tool to guarantee that your worker process(es) is
<em>always</em> running (even if it closes due to failure, hitting a message limit
or thanks to <code translate="no" class="notranslate">messenger:stop-workers</code>). You can install it on Ubuntu, for
example, via:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>sudo apt-get install supervisor</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Supervisor configuration files typically live in a <code translate="no" class="notranslate">/etc/supervisor/conf.d</code>
directory. For example, you can create a new <code translate="no" class="notranslate">messenger-worker.conf</code> file
there to make sure that 2 instances of <code translate="no" class="notranslate">messenger:consume</code> are running at all
times:</p>
<div translate="no" class="highlight-ini notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs ini"><span class="hljs-comment">;/etc/supervisor/conf.d/messenger-worker.conf</span>
<span class="hljs-section">[program:messenger-consume]</span>
<span class="hljs-attr">command</span>=php /path/to/your/app/bin/console messenger:consume async --time-limit=<span class="hljs-number">3600</span>
<span class="hljs-attr">user</span>=ubuntu
<span class="hljs-attr">numprocs</span>=<span class="hljs-number">2</span>
<span class="hljs-attr">startsecs</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">autostart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">startretries</span>=<span class="hljs-number">10</span>
<span class="hljs-attr">process_name</span>=%(program_name)s_%(process_num)<span class="hljs-number">02</span>d</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Change the <code translate="no" class="notranslate">async</code> argument to use the name of your transport (or transports)
and <code translate="no" class="notranslate">user</code> to the Unix user on your server.</p>
<div class="admonition admonition-caution ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Caution</span>
    </p><p>During a deployment, something might be unavailable (e.g. the
database) causing the consumer to fail to start. In this situation,
Supervisor will try <code translate="no" class="notranslate">startretries</code> number of times to restart the
command. Make sure to change this setting to avoid getting the command
in a FATAL state, which will never restart again.</p>
<p>Each restart, Supervisor increases the delay by 1 second. For instance, if
the value is <code translate="no" class="notranslate">10</code>, it will wait 1 sec, 2 sec, 3 sec, etc. This gives the
service a total of 55 seconds to become available again. Increase the
<code translate="no" class="notranslate">startretries</code> setting to cover the maximum expected downtime.</p>
</div>
<p>If you use the Redis Transport, note that each worker needs a unique consumer
name to avoid the same message being handled by multiple workers. One way to
achieve this is to set an environment variable in the Supervisor configuration
file, which you can then refer to in <code translate="no" class="notranslate">messenger.yaml</code>
(see the ref:`Redis section &lt;messenger-redis-transport&gt;` below):</p>
<div translate="no" class="highlight-ini notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs ini"><span class="hljs-attr">environment</span>=MESSENGER_CONSUMER_NAME=%(program_name)s_%(process_num)<span class="hljs-number">02</span>d</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Next, tell Supervisor to read your config and start your workers:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>sudo supervisorctl reread

<span class="hljs-prompt">$ </span>sudo supervisorctl update

<span class="hljs-prompt">$ </span>sudo supervisorctl start messenger-consume:*</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>See the <a href="http://supervisord.org/" class="reference external" rel="external noopener noreferrer" target="_blank">Supervisor docs</a> for more details.</p>
<div class="section">
<h4 id="graceful-shutdown">
    Graceful Shutdown
    <a class="headerlink" href="#graceful-shutdown" title="Permalink to this headline">¶</a>
</h4>
<p>If you install the <a href="https://www.php.net/manual/book.pcntl.php" class="reference external" rel="external noopener noreferrer" target="_blank">PCNTL</a> PHP extension in your project, workers will handle
the <code translate="no" class="notranslate">SIGTERM</code> or <code translate="no" class="notranslate">SIGINT</code> POSIX signals to finish processing their current
message before terminating.</p>
<p>However, you might prefer to use different POSIX signals for graceful shutdown.
You can override default ones by setting the <code translate="no" class="notranslate">framework.messenger.stop_worker_on_signals</code>
configuration option.</p>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.3</span>
    </p><p>The <code translate="no" class="notranslate">framework.messenger.stop_worker_on_signals</code> option was introduced in Symfony 6.3.</p>
</div>
<p>In some cases the <code translate="no" class="notranslate">SIGTERM</code> signal is sent by Supervisor itself (e.g. stopping
a Docker container having Supervisor as its entrypoint). In these cases you
need to add a <code translate="no" class="notranslate">stopwaitsecs</code> key to the program configuration (with a value
of the desired grace period in seconds) in order to perform a graceful shutdown:</p>
<div translate="no" class="highlight-ini notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs ini"><span class="hljs-section">[program:x]</span>
<span class="hljs-attr">stopwaitsecs</span>=<span class="hljs-number">20</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<span id="messenger-systemd"></span>
</div>
</div>
<div class="section">
<h3 id="systemd-configuration">
    Systemd Configuration
    <a class="headerlink" href="#systemd-configuration" title="Permalink to this headline">¶</a>
</h3>
<p>While Supervisor is a great tool, it has the disadvantage that you need system
access to run it. Systemd has become the standard on most Linux distributions,
and has a good alternative called <em>user services</em>.</p>
<p>Systemd user service configuration files typically live in a <code translate="no" class="notranslate">~/.config/systemd/user</code>
directory. For example, you can create a new <code translate="no" class="notranslate">messenger-worker.service</code> file. Or a
<code translate="no" class="notranslate">messenger-worker@.service</code> file if you want more instances running at the same time:</p>
<div translate="no" class="highlight-ini notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs ini"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Symfony messenger-consume %i

<span class="hljs-section">[Service]</span>
<span class="hljs-attr">ExecStart</span>=php /path/to/your/app/bin/console messenger:consume async --time-limit=<span class="hljs-number">3600</span>
<span class="hljs-attr">Restart</span>=always
<span class="hljs-attr">RestartSec</span>=<span class="hljs-number">30</span>

<span class="hljs-section">[Install]</span>
<span class="hljs-attr">WantedBy</span>=default.target</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Now, tell systemd to enable and start one worker:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>systemctl --user <span class="hljs-built_in">enable</span> messenger-worker@1.service
<span class="hljs-prompt">$ </span>systemctl --user start messenger-worker@1.service

<span class="hljs-comment"># to enable and start 20 workers</span>
<span class="hljs-prompt">$ </span>systemctl --user <span class="hljs-built_in">enable</span> messenger-worker@{1..20}.service
<span class="hljs-prompt">$ </span>systemctl --user start messenger-worker@{1..20}.service</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>If you change your service config file, you need to reload the daemon:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>systemctl --user daemon-reload</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>To restart all your consumers:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>systemctl --user restart messenger-consume@*.service</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The systemd user instance is only started after the first login of the
particular user. Consumer often need to start on system boot instead.
Enable lingering on the user to activate that behavior:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>loginctl <span class="hljs-built_in">enable</span>-linger &lt;your-username&gt;</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Logs are managed by journald and can be worked with using the journalctl
command:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-comment"># follow logs of consumer nr 11</span>
<span class="hljs-prompt">$ </span>journalctl -f --user-unit messenger-consume@11.service

<span class="hljs-comment"># follow logs of all consumers</span>
<span class="hljs-prompt">$ </span>journalctl -f --user-unit messenger-consume@*

<span class="hljs-comment"># follow all logs from your user services</span>
<span class="hljs-prompt">$ </span>journalctl -f _UID=<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>UID</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>See the <a href="https://www.freedesktop.org/wiki/Software/systemd/" class="reference external" rel="external noopener noreferrer" target="_blank">systemd docs</a> for more details.</p>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>You either need elevated privileges for the <code translate="no" class="notranslate">journalctl</code> command, or add
your user to the systemd-journal group:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>sudo usermod -a -G systemd-journal &lt;your-username&gt;</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
</div>
</div>
<div class="section">
<h3 id="stateless-worker">
    Stateless Worker
    <a class="headerlink" href="#stateless-worker" title="Permalink to this headline">¶</a>
</h3>
<p>PHP is designed to be stateless, there are no shared resources across different
requests. In HTTP context PHP cleans everything after sending the response, so
you can decide to not take care of services that may leak memory.</p>
<p>On the other hand, it's common for workers to process messages sequentially in
long-running CLI processes which don't finish after processing a single message.
Beware about service states to prevent information and/or memory leakage as
Symfony will inject the same instance of a service in all messages, preserving
the internal state of the services.</p>
<p>However, certain Symfony services, such as the Monolog
<a href="logging.html#logging-handler-fingers_crossed" class="reference internal">fingers crossed handler</a>, leak by design.
Symfony provides a <strong>service reset</strong> feature to solve this problem. When resetting
the container automatically between two messages, Symfony looks for any services
implementing <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Contracts/Service/ResetInterface.php" class="reference external" title="Symfony\Contracts\Service\ResetInterface" rel="external noopener noreferrer" target="_blank">ResetInterface</a> (including your
own services) and calls their <code translate="no" class="notranslate">reset()</code> method so they can clean their internal state.</p>
<p>If a service is not stateless and you want to reset its properties after each message, then
the service must implement <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Contracts/Service/ResetInterface.php" class="reference external" title="Symfony\Contracts\Service\ResetInterface" rel="external noopener noreferrer" target="_blank">ResetInterface</a> where you can reset the
properties in the <code translate="no" class="notranslate">reset()</code> method.</p>
<p>If you don't want to reset the container, add the <code translate="no" class="notranslate">--no-reset</code> option when
running the <code translate="no" class="notranslate">messenger:consume</code> command.</p>
<div class="admonition admonition-deprecated ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>In Symfony versions previous to 6.1, the service container didn't reset
automatically between messages and you had to set the
<code translate="no" class="notranslate">framework.messenger.reset_on_message</code> option to <code translate="no" class="notranslate">true</code>.</p>
</div>
<span id="messenger-retries-failures"></span>
</div>
</div>
<div class="section">
<h2 id="retries-failures">
    Retries &amp; Failures
    <a class="headerlink" href="#retries-failures" title="Permalink to this headline">¶</a>
</h2>
<p>If an exception is thrown while consuming a message from a transport it will
automatically be re-sent to the transport to be tried again. By default, a message
will be retried 3 times before being discarded or
<a href="messenger.html#messenger-failure-transport" class="reference internal">sent to the failure transport</a>. Each retry
will also be delayed, in case the failure was due to a temporary issue. All of
this is configurable for each transport:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-7d36db8687336e9075cd84efcc97d7418f47bf19" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-1954e543f5ebeecc7af9db2f4bd3cad23ef673e8" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-25d550edf2a23c1980e134839a753692a4c523cb" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-7d36db8687336e9075cd84efcc97d7418f47bf19" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_high:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">'%env(MESSENGER_TRANSPORT_DSN)%'</span>

                <span class="hljs-comment"># default configuration</span>
                <span class="hljs-attr">retry_strategy:</span>
                    <span class="hljs-attr">max_retries:</span> <span class="hljs-number">3</span>
                    <span class="hljs-comment"># milliseconds delay</span>
                    <span class="hljs-attr">delay:</span> <span class="hljs-number">1000</span>
                    <span class="hljs-comment"># causes the delay to be higher before each retry</span>
                    <span class="hljs-comment"># e.g. 1 second delay, 2 seconds, 4 seconds</span>
                    <span class="hljs-attr">multiplier:</span> <span class="hljs-number">2</span>
                    <span class="hljs-attr">max_delay:</span> <span class="hljs-number">0</span>
                    <span class="hljs-comment"># override all of this with a service that</span>
                    <span class="hljs-comment"># implements Symfony\Component\Messenger\Retry\RetryStrategyInterface</span>
                    <span class="hljs-comment"># service: null</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-1954e543f5ebeecc7af9db2f4bd3cad23ef673e8" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_high"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%?queue_name=high_priority"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:retry-strategy</span> <span class="hljs-attr">max-retries</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">delay</span>=<span class="hljs-string">"1000"</span> <span class="hljs-attr">multiplier</span>=<span class="hljs-string">"2"</span> <span class="hljs-attr">max-delay</span>=<span class="hljs-string">"0"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-25d550edf2a23c1980e134839a753692a4c523cb" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_high'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
        <span class="hljs-comment">// default configuration</span>
        <span class="hljs-operator">-&gt;</span>retryStrategy()
            <span class="hljs-operator">-&gt;</span>maxRetries(<span class="hljs-number">3</span>)
            <span class="hljs-comment">// milliseconds delay</span>
            <span class="hljs-operator">-&gt;</span>delay(<span class="hljs-number">1000</span>)
            <span class="hljs-comment">// causes the delay to be higher before each retry</span>
            <span class="hljs-comment">// e.g. 1 second delay, 2 seconds, 4 seconds</span>
            <span class="hljs-operator">-&gt;</span>multiplier(<span class="hljs-number">2</span>)
            <span class="hljs-operator">-&gt;</span>maxDelay(<span class="hljs-number">0</span>)
            <span class="hljs-comment">// override all of this with a service that</span>
            <span class="hljs-comment">// implements Symfony\Component\Messenger\Retry\RetryStrategyInterface</span>
            <span class="hljs-operator">-&gt;</span>service(<span class="hljs-keyword">null</span>)
    ;
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>Symfony triggers a <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerMessageRetriedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerMessageRetriedEvent" rel="external noopener noreferrer" target="_blank">WorkerMessageRetriedEvent</a>
when a message is retried so you can run your own logic.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>Thanks to <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Stamp/SerializedMessageStamp.php" class="reference external" title="Symfony\Component\Messenger\Stamp\SerializedMessageStamp" rel="external noopener noreferrer" target="_blank">SerializedMessageStamp</a>,
the serialized form of the message is saved, which prevents to serialize it
again if the message is later retried.</p>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>The <code translate="no" class="notranslate">SerializedMessageStamp</code> class was introduced in Symfony 6.1.</p>
</div>
</div>
<div class="section">
<h3 id="avoiding-retrying">
    Avoiding Retrying
    <a class="headerlink" href="#avoiding-retrying" title="Permalink to this headline">¶</a>
</h3>
<p>Sometimes handling a message might fail in a way that you <em>know</em> is permanent
and should not be retried. If you throw
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Exception/UnrecoverableMessageHandlingException.php" class="reference external" title="Symfony\Component\Messenger\Exception\UnrecoverableMessageHandlingException" rel="external noopener noreferrer" target="_blank">UnrecoverableMessageHandlingException</a>,
the message will not be retried.</p>
</div>
<div class="section">
<h3 id="forcing-retrying">
    Forcing Retrying
    <a class="headerlink" href="#forcing-retrying" title="Permalink to this headline">¶</a>
</h3>
<p>Sometimes handling a message must fail in a way that you <em>know</em> is temporary
and must be retried. If you throw
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Exception/RecoverableMessageHandlingException.php" class="reference external" title="Symfony\Component\Messenger\Exception\RecoverableMessageHandlingException" rel="external noopener noreferrer" target="_blank">RecoverableMessageHandlingException</a>,
the message will always be retried infinitely and <code translate="no" class="notranslate">max_retries</code> setting will be ignored.</p>
<span id="messenger-failure-transport"></span>
</div>
<div class="section">
<h3 id="saving-retrying-failed-messages">
    Saving &amp; Retrying Failed Messages
    <a class="headerlink" href="#saving-retrying-failed-messages" title="Permalink to this headline">¶</a>
</h3>
<p>If a message fails it is retried multiple times (<code translate="no" class="notranslate">max_retries</code>) and then will
be discarded. To avoid this happening, you can instead configure a <code translate="no" class="notranslate">failure_transport</code>:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-f37ebb00d414b3ee6534824c884a94d6fa3c26ba" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-7d2264d428e0ca004210d88a624d0ccca0a56608" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-b806a6c517d32a68fd7eea1699d52b85a49b0bb4" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-f37ebb00d414b3ee6534824c884a94d6fa3c26ba" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-comment"># after retrying, messages will be sent to the "failed" transport</span>
        <span class="hljs-attr">failure_transport:</span> <span class="hljs-string">failed</span>

        <span class="hljs-attr">transports:</span>
            <span class="hljs-comment"># ... other transports</span>

            <span class="hljs-attr">failed:</span> <span class="hljs-string">'doctrine://default?queue_name=failed'</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-7d2264d428e0ca004210d88a624d0ccca0a56608" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- after retrying, messages will be sent to the "failed" transport --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span> <span class="hljs-attr">failure-transport</span>=<span class="hljs-string">"failed"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- ... other transports --&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"failed"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"doctrine://default?queue_name=failed"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-b806a6c517d32a68fd7eea1699d52b85a49b0bb4" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-comment">// after retrying, messages will be sent to the "failed" transport</span>
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>failureTransport(<span class="hljs-string">'failed'</span>);

    <span class="hljs-comment">// ... other transports</span>

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'failed'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'doctrine://default?queue_name=failed'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>In this example, if handling a message fails 3 times (default <code translate="no" class="notranslate">max_retries</code>),
it will then be sent to the <code translate="no" class="notranslate">failed</code> transport. While you <em>can</em> use
<code translate="no" class="notranslate">messenger:consume failed</code> to consume this like a normal transport, you'll
usually want to manually view the messages in the failure transport and choose
to retry them:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-comment"># see all messages in the failure transport with a default limit of 50</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show

<span class="hljs-comment"># see the 10 first messages</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show --max=10

<span class="hljs-comment"># see only MyClass messages</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show --class-filter=<span class="hljs-string">'MyClass'</span>

<span class="hljs-comment"># see the number of messages by message class</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show --stats

<span class="hljs-comment"># see details about a specific failure</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show 20 -vv

<span class="hljs-comment"># view and retry messages one-by-one</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:retry -vv

<span class="hljs-comment"># retry specific messages</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:retry 20 30 --force

<span class="hljs-comment"># remove a message without retrying it</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:remove 20

<span class="hljs-comment"># remove messages without retrying them and show each message before removing it</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:remove 20 30 --show-messages</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.2</span>
    </p><p>The <code translate="no" class="notranslate">--class-filter</code> and <code translate="no" class="notranslate">--stats</code> options were introduced in Symfony 6.2.</p>
</div>
<p>If the message fails again, it will be re-sent back to the failure transport
due to the normal <a href="messenger.html#messenger-retries-failures" class="reference internal">retry rules</a>. Once the max
retry has been hit, the message will be discarded permanently.</p>
</div>
<div class="section">
<h3 id="multiple-failed-transports">
    Multiple Failed Transports
    <a class="headerlink" href="#multiple-failed-transports" title="Permalink to this headline">¶</a>
</h3>
<p>Sometimes it is not enough to have a single, global <code translate="no" class="notranslate">failed transport</code> configured
because some messages are more important than others. In those cases, you can
override the failure transport for only specific transports:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-01ee43df2e3fd858f68c23cf7383fb1885e1985b" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-6e90437d7bc0257394755f63b203ab62c0e0d4d3" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-68ef1e9cc49207cba57e7421d8f0b918badd4a56" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-01ee43df2e3fd858f68c23cf7383fb1885e1985b" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-comment"># after retrying, messages will be sent to the "failed" transport</span>
        <span class="hljs-comment"># by default if no "failed_transport" is configured inside a transport</span>
        <span class="hljs-attr">failure_transport:</span> <span class="hljs-string">failed_default</span>

        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_high:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">'%env(MESSENGER_TRANSPORT_DSN)%'</span>
                <span class="hljs-attr">failure_transport:</span> <span class="hljs-string">failed_high_priority</span>

            <span class="hljs-comment"># since no failed transport is configured, the one used will be</span>
            <span class="hljs-comment"># the global "failure_transport" set</span>
            <span class="hljs-attr">async_priority_low:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">'doctrine://default?queue_name=async_priority_low'</span>

            <span class="hljs-attr">failed_default:</span> <span class="hljs-string">'doctrine://default?queue_name=failed_default'</span>
            <span class="hljs-attr">failed_high_priority:</span> <span class="hljs-string">'doctrine://default?queue_name=failed_high_priority'</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-6e90437d7bc0257394755f63b203ab62c0e0d4d3" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- after retrying, messages will be sent to the "failed" transport
        by default if no "failed-transport" is configured inside a transport --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span> <span class="hljs-attr">failure-transport</span>=<span class="hljs-string">"failed_default"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_high"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span> <span class="hljs-attr">failure-transport</span>=<span class="hljs-string">"failed_high_priority"</span>/&gt;</span>
            <span class="hljs-comment">&lt;!-- since no "failed_transport" is configured, the one used will be
            the global "failed_transport" set --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_low"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"doctrine://default?queue_name=async_priority_low"</span>/&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"failed_default"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"doctrine://default?queue_name=failed_default"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"failed_high_priority"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"doctrine://default?queue_name=failed_high_priority"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-68ef1e9cc49207cba57e7421d8f0b918badd4a56" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-comment">// after retrying, messages will be sent to the "failed" transport</span>
    <span class="hljs-comment">// by default if no "failure_transport" is configured inside a transport</span>
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>failureTransport(<span class="hljs-string">'failed_default'</span>);

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_high'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
        <span class="hljs-operator">-&gt;</span>failureTransport(<span class="hljs-string">'failed_high_priority'</span>);

    <span class="hljs-comment">// since no failed transport is configured, the one used will be</span>
    <span class="hljs-comment">// the global failure_transport set</span>
   <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_low'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'doctrine://default?queue_name=async_priority_low'</span>);

   <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'failed_default'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'doctrine://default?queue_name=failed_default'</span>);

   <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'failed_high_priority'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'doctrine://default?queue_name=failed_high_priority'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>If there is no <code translate="no" class="notranslate">failure_transport</code> defined globally or on the transport level,
the messages will be discarded after the number of retries.</p>
<p>The failed commands have an optional option <code translate="no" class="notranslate">--transport</code> to specify
the <code translate="no" class="notranslate">failure_transport</code> configured at the transport level.</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-comment"># see all messages in "failure_transport" transport</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:show --transport=failure_transport

<span class="hljs-comment"># retry specific messages from "failure_transport"</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:retry 20 30 --transport=failure_transport --force

<span class="hljs-comment"># remove a message without retrying it from "failure_transport"</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:failed:remove 20 --transport=failure_transport</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<span id="messenger-transports-config"></span>
</div>
</div>
<div class="section">
<h2 id="transport-configuration">
    Transport Configuration
    <a class="headerlink" href="#transport-configuration" title="Permalink to this headline">¶</a>
</h2>
<p>Messenger supports a number of different transport types, each with their own
options. Options can be passed to the transport via a DSN string or configuration.</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=amqp://localhost/%2f/messages?auto_setup=<span class="hljs-literal">false</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-463d4c464ad4ee5e00f2ab12d312ffcadbb82152" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-a8253737e0efb2d2fa5710be8e69bbc26b8d1be1" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-0f48a8c3f4d743fe26acc47f9d1a67afb63dc54a" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-463d4c464ad4ee5e00f2ab12d312ffcadbb82152" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">my_transport:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>
                <span class="hljs-attr">options:</span>
                    <span class="hljs-attr">auto_setup:</span> <span class="hljs-literal">false</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-a8253737e0efb2d2fa5710be8e69bbc26b8d1be1" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"my_transport"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"%env(MESSENGER_TRANSPORT_DSN)%"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:options</span> <span class="hljs-attr">auto-setup</span>=<span class="hljs-string">"false"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:transport</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-0f48a8c3f4d743fe26acc47f9d1a67afb63dc54a" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'my_transport'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(env(<span class="hljs-string">'MESSENGER_TRANSPORT_DSN'</span>))
        <span class="hljs-operator">-&gt;</span>options([<span class="hljs-string">'auto_setup'</span> =&gt; <span class="hljs-keyword">false</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>Options defined under <code translate="no" class="notranslate">options</code> take precedence over ones defined in the DSN.</p>
<div class="section">
<h3 id="amqp-transport">
    AMQP Transport
    <a class="headerlink" href="#amqp-transport" title="Permalink to this headline">¶</a>
</h3>
<p>The AMQP transport uses the AMQP PHP extension to send messages to queues like
RabbitMQ. Install it by running:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/amqp-messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The AMQP transport DSN may looks like this:</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=amqp://guest:guest@localhost:5672/%2f/messages

<span class="hljs-comment"># or use the AMQPS protocol</span>
MESSENGER_TRANSPORT_DSN=amqps://guest:guest@localhost/%2f/messages</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>If you want to use TLS/SSL encrypted AMQP, you must also provide a CA certificate.
Define the certificate path in the <code translate="no" class="notranslate">amqp.cacert</code> PHP.ini setting
(e.g. <code translate="no" class="notranslate">amqp.cacert = /etc/ssl/certs</code>) or in the <code translate="no" class="notranslate">cacert</code> parameter of the
DSN (e.g <code translate="no" class="notranslate">amqps://localhost?cacert=/etc/ssl/certs/</code>).</p>
<p>The default port used by TLS/SSL encrypted AMQP is 5671, but you can overwrite
it in the <code translate="no" class="notranslate">port</code> parameter of the DSN (e.g. <code translate="no" class="notranslate">amqps://localhost?cacert=/etc/ssl/certs/&amp;port=12345</code>).</p>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>By default, the transport will automatically create any exchanges, queues and
binding keys that are needed. That can be disabled, but some functionality
may not work correctly (like delayed queues).
To not autocreate any queues, you can configure a transport with <code translate="no" class="notranslate">queues: []</code>.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>You can limit the consumer of an AMQP transport to only process messages
from some queues of an exchange. See <a href="messenger.html#messenger-limit-queues" class="reference internal">Messenger: Sync &amp; Queued Message Handling</a>.</p>
</div>
<p>The transport has a number of other options, including ways to configure
the exchange, queues binding keys and more. See the documentation on
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Bridge/Amqp/Transport/Connection.php" class="reference external" title="Symfony\Component\Messenger\Bridge\Amqp\Transport\Connection" rel="external noopener noreferrer" target="_blank">Connection</a>.</p>
<p>The transport has a number of options:</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td><code translate="no" class="notranslate">auto_setup</code></td>
                                    <td>Whether the exchanges and queues should be
created automatically during send / get.</td>
                                    <td><code translate="no" class="notranslate">true</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">cacert</code></td>
                                    <td>Path to the CA cert file in PEM format.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">cert</code></td>
                                    <td>Path to the client certificate in PEM format.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">channel_max</code></td>
                                    <td>Specifies highest channel number that the server
permits. 0 means standard extension limit</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">confirm_timeout</code></td>
                                    <td>Timeout in seconds for confirmation; if none
specified, transport will not wait for message
confirmation. Note: 0 or greater seconds. May be
fractional.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">connect_timeout</code></td>
                                    <td>Connection timeout. Note: 0 or greater seconds.
May be fractional.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">frame_max</code></td>
                                    <td>The largest frame size that the server proposes
for the connection, including frame header and
end-byte. 0 means standard extension limit
(depends on librabbimq default frame size limit)</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">heartbeat</code></td>
                                    <td>The delay, in seconds, of the connection
heartbeat that the server wants. 0 means the
server does not want a heartbeat. Note,
librabbitmq has limited heartbeat support, which
means heartbeats checked only during blocking
calls.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">host</code></td>
                                    <td>Hostname of the AMQP service</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">key</code></td>
                                    <td>Path to the client key in PEM format.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">login</code></td>
                                    <td>Username to use to connect the AMQP service</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">password</code></td>
                                    <td>Password to use to connect to the AMQP service</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">persistent</code></td>
                                    <td>&nbsp;</td>
                                    <td><code translate="no" class="notranslate">&#039;false&#039;</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">port</code></td>
                                    <td>Port of the AMQP service</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">read_timeout</code></td>
                                    <td>Timeout in for income activity. Note: 0 or
greater seconds. May be fractional.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">retry</code></td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">sasl_method</code></td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">connection_name</code></td>
                                    <td>For custom connection names (requires at least
version 1.10 of the PHP AMQP extension)</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">verify</code></td>
                                    <td>Enable or disable peer verification. If peer
verification is enabled then the common name in
the server certificate must match the server
name. Peer verification is enabled by default.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">vhost</code></td>
                                    <td>Virtual Host to use with the AMQP service</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">write_timeout</code></td>
                                    <td>Timeout in for outcome activity. Note: 0 or
greater seconds. May be fractional.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">delay[queue_name_pattern]</code></td>
                                    <td>Pattern to use to create the queues</td>
                                    <td><code translate="no" class="notranslate">delay_%exchange_name%_%routing_key%_%delay%</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">delay[exchange_name]</code></td>
                                    <td>Name of the exchange to be used for the
delayed/retried messages</td>
                                    <td><code translate="no" class="notranslate">delays</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">queues[name][arguments]</code></td>
                                    <td>Extra arguments</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">queues[name][binding_arguments]</code></td>
                                    <td>Arguments to be used while binding the queue.</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">queues[name][binding_keys]</code></td>
                                    <td>The binding keys (if any) to bind to this queue</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">queues[name][flags]</code></td>
                                    <td>Queue flags</td>
                                    <td><code translate="no" class="notranslate">AMQP_DURABLE</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">exchange[arguments]</code></td>
                                    <td>Extra arguments for the exchange (e.g.
<code translate="no" class="notranslate">alternate-exchange</code>)</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">exchange[default_publish_routing_key]</code></td>
                                    <td>Routing key to use when publishing, if none is
specified on the message</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">exchange[flags]</code></td>
                                    <td>Exchange flags</td>
                                    <td><code translate="no" class="notranslate">AMQP_DURABLE</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">exchange[name]</code></td>
                                    <td>Name of the exchange</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">exchange[type]</code></td>
                                    <td>Type of exchange</td>
                                    <td><code translate="no" class="notranslate">fanout</code></td>
                            </tr>
            </tbody>
</table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>The <code translate="no" class="notranslate">connection_name</code> option was introduced in Symfony 6.1.</p>
</div>
<p>You can also configure AMQP-specific settings on your message by adding
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Bridge/Amqp/Transport/AmqpStamp.php" class="reference external" title="Symfony\Component\Messenger\Bridge\Amqp\Transport\AmqpStamp" rel="external noopener noreferrer" target="_blank">AmqpStamp</a> to
your Envelope:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Bridge</span>\<span class="hljs-title">Amqp</span>\<span class="hljs-title">Transport</span>\<span class="hljs-title">AmqpStamp</span>;
<span class="hljs-comment">// ...</span>

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>attributes</span> = [];
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>dispatch(<span class="hljs-keyword">new</span> SmsNotification(), [
    <span class="hljs-keyword">new</span> AmqpStamp(<span class="hljs-string">'custom-routing-key'</span>, AMQP_NOPARAM, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>attributes</span>),
]);</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-caution ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Caution</span>
    </p><p>The consumers do not show up in an admin panel as this transport does not rely on
<code translate="no" class="notranslate">\AmqpQueue::consume()</code> which is blocking. Having a blocking receiver makes
the <code translate="no" class="notranslate">--time-limit/--memory-limit</code> options of the <code translate="no" class="notranslate">messenger:consume</code> command as well as
the <code translate="no" class="notranslate">messenger:stop-workers</code> command inefficient, as they all rely on the fact that
the receiver returns immediately no matter if it finds a message or not. The consume
worker is responsible for iterating until it receives a message to handle and/or until one
of the stop conditions is reached. Thus, the worker's stop logic cannot be reached if it
is stuck in a blocking call.</p>
</div>
</div>
<div class="section">
<h3 id="doctrine-transport">
    Doctrine Transport
    <a class="headerlink" href="#doctrine-transport" title="Permalink to this headline">¶</a>
</h3>
<p>The Doctrine transport can be used to store messages in a database table.
Install it by running:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/doctrine-messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The Doctrine transport DSN may looks like this:</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=doctrine://default</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The format is <code translate="no" class="notranslate">doctrine://&lt;connection_name&gt;</code>, in case you have multiple connections
and want to use one other than the &quot;default&quot;. The transport will automatically create
a table named <code translate="no" class="notranslate">messenger_messages</code>.</p>
<p>Or, to create the table yourself, set the <code translate="no" class="notranslate">auto_setup</code> option to <code translate="no" class="notranslate">false</code> and
<a href="doctrine.html#doctrine-creating-the-database-tables-schema" class="reference internal">generate a migration</a>.</p>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>To avoid tools like Doctrine Migrations from trying to remove this table because
it's not part of your normal schema, you can set the <code translate="no" class="notranslate">schema_filter</code> option:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-da19cf0737a57806f8514494b05366503803a146" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-6946952308c39ff4e759dc580a1ac67b290376e3" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-b68945c624d6af57ccffa8b7ed1d30381264b072" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-da19cf0737a57806f8514494b05366503803a146" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/doctrine.yaml</span>
<span class="hljs-attr">doctrine:</span>
    <span class="hljs-attr">dbal:</span>
        <span class="hljs-attr">schema_filter:</span> <span class="hljs-string">'~^(?!messenger_messages)~'</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-6946952308c39ff4e759dc580a1ac67b290376e3" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/doctrine.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">doctrine:dbal</span> <span class="hljs-attr">schema-filter</span>=<span class="hljs-string">"~^(?!messenger_messages)~"</span>/&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-b68945c624d6af57ccffa8b7ed1d30381264b072" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment"># config/packages/doctrine.php</span>
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>container</span><span class="hljs-operator">-&gt;</span>loadFromExtension(<span class="hljs-string">'doctrine'</span>, [
    <span class="hljs-string">'dbal'</span> =&gt; [
        <span class="hljs-string">'schema_filter'</span>  =&gt; <span class="hljs-string">'~^(?!messenger_messages)~'</span>,
        <span class="hljs-comment">// ...</span>
    ],
    <span class="hljs-comment">// ...</span>
]);</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
</div>
<div class="admonition admonition-caution ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Caution</span>
    </p><p>The datetime property of the messages stored in the database uses the
timezone of the current system. This may cause issues if multiple machines
with different timezone configuration use the same storage.</p>
</div>
<p>The transport has a number of options:</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td>table_name</td>
                                    <td>Name of the table</td>
                                    <td>messenger_messages</td>
                            </tr>
                    <tr>
                                    <td>queue_name</td>
                                    <td>Name of the queue (a column in the
table, to use one table for
multiple transports)</td>
                                    <td>default</td>
                            </tr>
                    <tr>
                                    <td>redeliver_timeout</td>
                                    <td>Timeout before retrying a message
that's in the queue but in the
&quot;handling&quot; state (if a worker stopped
for some reason, this will occur,
eventually you should retry the
message) - in seconds.</td>
                                    <td>3600</td>
                            </tr>
                    <tr>
                                    <td>auto_setup</td>
                                    <td>Whether the table should be created
automatically during send / get.</td>
                                    <td>true</td>
                            </tr>
            </tbody>
</table>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>Set <code translate="no" class="notranslate">redeliver_timeout</code> to a greater value than your slowest message
duration. Otherwise, some messages will start a second time while the
first one is still being handled.</p>
</div>
<p>When using PostgreSQL, you have access to the following options to leverage
the <a href="https://www.postgresql.org/docs/current/sql-notify.html" class="reference external" rel="external noopener noreferrer" target="_blank">LISTEN/NOTIFY</a> feature. This allow for a more performant approach
than the default polling behavior of the Doctrine transport because
PostgreSQL will directly notify the workers when a new message is inserted
in the table.</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td>use_notify</td>
                                    <td>Whether to use LISTEN/NOTIFY.</td>
                                    <td>true</td>
                            </tr>
                    <tr>
                                    <td>check_delayed_interval</td>
                                    <td>The interval to check for delayed
messages, in milliseconds.
Set to 0 to disable checks.</td>
                                    <td>60000</td>
                            </tr>
                    <tr>
                                    <td>get_notify_timeout</td>
                                    <td>The length of time to wait for a
response when calling
<code translate="no" class="notranslate">PDO::pgsqlGetNotify</code>, in milliseconds.</td>
                                    <td>0</td>
                            </tr>
            </tbody>
</table>
</div>
</div>
<div class="section">
<h3 id="beanstalkd-transport">
    Beanstalkd Transport
    <a class="headerlink" href="#beanstalkd-transport" title="Permalink to this headline">¶</a>
</h3>
<p>The Beanstalkd transport sends messages directly to a Beanstalkd work queue. Install
it by running:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/beanstalkd-messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The Beanstalkd transport DSN may looks like this:</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=beanstalkd://localhost:11300?tube_name=foo&amp;timeout=4&amp;ttr=120

<span class="hljs-comment"># If no port, it will default to 11300</span>
MESSENGER_TRANSPORT_DSN=beanstalkd://localhost</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The transport has a number of options:</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td>tube_name</td>
                                    <td>Name of the queue</td>
                                    <td>default</td>
                            </tr>
                    <tr>
                                    <td>timeout</td>
                                    <td>Message reservation timeout
- in seconds.</td>
                                    <td>0 (will cause the
server to immediately
return either a
response or a
TransportException
will be thrown)</td>
                            </tr>
                    <tr>
                                    <td>ttr</td>
                                    <td>The message time to run before it
is put back in the ready queue
- in seconds.</td>
                                    <td>90</td>
                            </tr>
            </tbody>
</table>
</div>
<span id="messenger-redis-transport"></span>
</div>
<div class="section">
<h3 id="redis-transport">
    Redis Transport
    <a class="headerlink" href="#redis-transport" title="Permalink to this headline">¶</a>
</h3>
<p>The Redis transport uses <a href="https://redis.io/topics/streams-intro" class="reference external" rel="external noopener noreferrer" target="_blank">streams</a> to queue messages. This transport requires
the Redis PHP extension (&gt;=4.3) and a running Redis server (^5.0). Install it by
running:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/redis-messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The Redis transport DSN may looks like this:</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=redis://localhost:6379/messages
<span class="hljs-comment"># Full DSN Example</span>
MESSENGER_TRANSPORT_DSN=redis://password@localhost:6379/messages/symfony/consumer?auto_setup=<span class="hljs-literal">true</span>&amp;serializer=1&amp;stream_max_entries=0&amp;dbindex=0
<span class="hljs-comment"># Redis Cluster Example</span>
MESSENGER_TRANSPORT_DSN=redis://host-01:6379,redis://host-02:6379,redis://host-03:6379,redis://host-04:6379
<span class="hljs-comment"># Unix Socket Example</span>
MESSENGER_TRANSPORT_DSN=redis:///var/run/redis.sock</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>A number of options can be configured via the DSN or via the <code translate="no" class="notranslate">options</code> key
under the transport in <code translate="no" class="notranslate">messenger.yaml</code>:</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td>stream</td>
                                    <td>The Redis stream name</td>
                                    <td>messages</td>
                            </tr>
                    <tr>
                                    <td>group</td>
                                    <td>The Redis consumer group name</td>
                                    <td>symfony</td>
                            </tr>
                    <tr>
                                    <td>consumer</td>
                                    <td>Consumer name used in Redis</td>
                                    <td>consumer</td>
                            </tr>
                    <tr>
                                    <td>auto_setup</td>
                                    <td>Create the Redis group automatically?</td>
                                    <td>true</td>
                            </tr>
                    <tr>
                                    <td>auth</td>
                                    <td>The Redis password</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td>delete_after_ack</td>
                                    <td>If <code translate="no" class="notranslate">true</code>, messages are deleted
automatically after processing them</td>
                                    <td>true</td>
                            </tr>
                    <tr>
                                    <td>delete_after_reject</td>
                                    <td>If <code translate="no" class="notranslate">true</code>, messages are deleted
automatically if they are rejected</td>
                                    <td>true</td>
                            </tr>
                    <tr>
                                    <td>lazy</td>
                                    <td>Connect only when a connection is
really needed</td>
                                    <td>false</td>
                            </tr>
                    <tr>
                                    <td>serializer</td>
                                    <td>How to serialize the final payload
in Redis (the
<code translate="no" class="notranslate">Redis::OPT_SERIALIZER</code> option)</td>
                                    <td><code translate="no" class="notranslate">Redis::SERIALIZER_PHP</code></td>
                            </tr>
                    <tr>
                                    <td>stream_max_entries</td>
                                    <td>The maximum number of entries which
the stream will be trimmed to. Set
it to a large enough number to
avoid losing pending messages</td>
                                    <td><code translate="no" class="notranslate">0</code> (which means &quot;no trimming&quot;)</td>
                            </tr>
                    <tr>
                                    <td>tls</td>
                                    <td>Enable TLS support for the connection</td>
                                    <td>false</td>
                            </tr>
                    <tr>
                                    <td>redeliver_timeout</td>
                                    <td>Timeout before retrying a pending
message which is owned by an
abandoned consumer (if a worker died
for some reason, this will occur,
eventually you should retry the
message) - in seconds.</td>
                                    <td><code translate="no" class="notranslate">3600</code></td>
                            </tr>
                    <tr>
                                    <td>claim_interval</td>
                                    <td>Interval on which pending/abandoned
messages should be checked for to
claim - in milliseconds</td>
                                    <td><code translate="no" class="notranslate">60000</code> (1 Minute)</td>
                            </tr>
                    <tr>
                                    <td>persistent_id</td>
                                    <td>String, if null connection is
non-persistent.</td>
                                    <td>null</td>
                            </tr>
                    <tr>
                                    <td>retry_interval</td>
                                    <td>Int, value in milliseconds</td>
                                    <td><code translate="no" class="notranslate">0</code></td>
                            </tr>
                    <tr>
                                    <td>read_timeout</td>
                                    <td>Float, value in seconds
default indicates unlimited</td>
                                    <td><code translate="no" class="notranslate">0</code></td>
                            </tr>
                    <tr>
                                    <td>timeout</td>
                                    <td>Float, value in seconds
default indicates unlimited</td>
                                    <td><code translate="no" class="notranslate">0</code></td>
                            </tr>
                    <tr>
                                    <td>sentinel_master</td>
                                    <td>String, if null or empty Sentinel
support is disabled</td>
                                    <td>null</td>
                            </tr>
            </tbody>
</table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>The <code translate="no" class="notranslate">persistent_id</code>, <code translate="no" class="notranslate">retry_interval</code>, <code translate="no" class="notranslate">read_timeout</code>, <code translate="no" class="notranslate">timeout</code>, and
<code translate="no" class="notranslate">sentinel_master</code> options were introduced in Symfony 6.1.</p>
</div>
<div class="admonition admonition-caution ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Caution</span>
    </p><p>There should never be more than one <code translate="no" class="notranslate">messenger:consume</code> command running with the same
combination of <code translate="no" class="notranslate">stream</code>, <code translate="no" class="notranslate">group</code> and <code translate="no" class="notranslate">consumer</code>, or messages could end up being
handled more than once. If you run multiple queue workers, <code translate="no" class="notranslate">consumer</code> can be set to an
environment variable, like <code translate="no" class="notranslate">%env(MESSENGER_CONSUMER_NAME)%</code>, set by Supervisor
(example below) or any other service used to manage the worker processes.
In a container environment, the <code translate="no" class="notranslate">HOSTNAME</code> can be used as the consumer name, since
there is only one worker per container/host. If using Kubernetes to orchestrate the
containers, consider using a <code translate="no" class="notranslate">StatefulSet</code> to have stable names.</p>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>Set <code translate="no" class="notranslate">delete_after_ack</code> to <code translate="no" class="notranslate">true</code> (if you use a single group) or define
<code translate="no" class="notranslate">stream_max_entries</code> (if you can estimate how many max entries is acceptable
in your case) to avoid memory leaks. Otherwise, all messages will remain
forever in Redis.</p>
</div>
</div>
<div class="section">
<h3 id="in-memory-transport">
    In Memory Transport
    <a class="headerlink" href="#in-memory-transport" title="Permalink to this headline">¶</a>
</h3>
<p>The <code translate="no" class="notranslate">in-memory</code> transport does not actually deliver messages. Instead, it
holds them in memory during the request, which can be useful for testing.
For example, if you have an <code translate="no" class="notranslate">async_priority_normal</code> transport, you could
override it in the <code translate="no" class="notranslate">test</code> environment to use this transport:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-c709192cf950a402e955b77a3048776235a70e4f" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-c78cf88cdc2858174b61795ea1b33dfa458beec0" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-810ea087b53263cdc9a1d7a9a5f3ed6cccc48914" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-c709192cf950a402e955b77a3048776235a70e4f" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/test/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_normal:</span> <span class="hljs-string">'in-memory://'</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-c78cf88cdc2858174b61795ea1b33dfa458beec0" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/test/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_normal"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"in-memory://"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-810ea087b53263cdc9a1d7a9a5f3ed6cccc48914" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/test/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_normal'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'in-memory://'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>Then, while testing, messages will <em>not</em> be delivered to the real transport.
Even better, in a test, you can check that exactly one message was sent
during a request:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// tests/Controller/DefaultControllerTest.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Tests</span>\<span class="hljs-title">Controller</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Bundle</span>\<span class="hljs-title">FrameworkBundle</span>\<span class="hljs-title">Test</span>\<span class="hljs-title">WebTestCase</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Transport</span>\<span class="hljs-title">InMemory</span>\<span class="hljs-title">InMemoryTransport</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultControllerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebTestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testSomething</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>client</span> = <span class="hljs-keyword">static</span><span class="hljs-operator">::</span>createClient();
        <span class="hljs-comment">// ...</span>

        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>assertSame(<span class="hljs-number">200</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>client</span><span class="hljs-operator">-&gt;</span>getResponse()<span class="hljs-operator">-&gt;</span>getStatusCode());

        <span class="hljs-comment">/* <span class="hljs-doctag">@var</span> InMemoryTransport $transport */</span>
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>transport</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>getContainer()<span class="hljs-operator">-&gt;</span>get(<span class="hljs-string">'messenger.transport.async_priority_normal'</span>);
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>assertCount(<span class="hljs-number">1</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>transport</span><span class="hljs-operator">-&gt;</span>getSent());
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.3</span>
    </p><p>The namespace of the <code translate="no" class="notranslate">InMemoryTransport</code> class changed in Symfony 6.3 from
<code translate="no" class="notranslate">Symfony<wbr>\Component<wbr>\Messenger<wbr>\Transport<wbr>\InMemoryTransport</code> to
<code translate="no" class="notranslate">Symfony<wbr>\Component<wbr>\Messenger<wbr>\Transport<wbr>\InMemory<wbr>\InMemoryTransport</code>.</p>
</div>
<p>The transport has a number of options:</p>
<dl>
                        <dt><code translate="no" class="notranslate">serialize</code> (boolean, default: <code translate="no" class="notranslate">false</code>)</dt>
        
        <dd>
                            Whether to serialize messages or not. This is useful to test an additional
layer, especially when you use your own message serializer.
                    </dd>
    </dl>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>All <code translate="no" class="notranslate">in-memory</code> transports will be reset automatically after each test <strong>in</strong>
test classes extending
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Bundle/FrameworkBundle/Test/KernelTestCase.php" class="reference external" title="Symfony\Bundle\FrameworkBundle\Test\KernelTestCase" rel="external noopener noreferrer" target="_blank">KernelTestCase</a>
or <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Bundle/FrameworkBundle/Test/WebTestCase.php" class="reference external" title="Symfony\Bundle\FrameworkBundle\Test\WebTestCase" rel="external noopener noreferrer" target="_blank">WebTestCase</a>.</p>
</div>
</div>
<div class="section">
<h3 id="amazon-sqs">
    Amazon SQS
    <a class="headerlink" href="#amazon-sqs" title="Permalink to this headline">¶</a>
</h3>
<p>The Amazon SQS transport is perfect for applications hosted on AWS. Install it by
running:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/amazon-sqs-messenger</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The SQS transport DSN may looks like this:</p>
<div translate="no" class="highlight-env highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs env bash"><span class="hljs-comment"># .env</span>
MESSENGER_TRANSPORT_DSN=https://sqs.eu-west-3.amazonaws.com/123456789012/messages?access_key=AKIAIOSFODNN7EXAMPLE&amp;secret_key=j17M97ffSVoKI0briFoo9a
MESSENGER_TRANSPORT_DSN=sqs://localhost:9494/messages?sslmode=<span class="hljs-built_in">disable</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>The transport will automatically create queues that are needed. This
can be disabled by setting the <code translate="no" class="notranslate">auto_setup</code> option to <code translate="no" class="notranslate">false</code>.</p>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>Before sending or receiving a message, Symfony needs to convert the queue
name into an AWS queue URL by calling the <code translate="no" class="notranslate">GetQueueUrl</code> API in AWS. This
extra API call can be avoided by providing a DSN which is the queue URL.</p>
</div>
<p>The transport has a number of options:</p>
<div class="table-wrapper">
<table>
            <thead>
                            <tr>
                                            <th>Option</th>
                                            <th>Description</th>
                                            <th>Default</th>
                                    </tr>
                    </thead>
        <tbody>
                    <tr>
                                    <td><code translate="no" class="notranslate">access_key</code></td>
                                    <td>AWS access key</td>
                                    <td>must be urlencoded</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">account</code></td>
                                    <td>Identifier of the AWS account</td>
                                    <td>The owner of the credentials</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">auto_setup</code></td>
                                    <td>Whether the queue should be created
automatically during send / get.</td>
                                    <td><code translate="no" class="notranslate">true</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">buffer_size</code></td>
                                    <td>Number of messages to prefetch</td>
                                    <td>9</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">debug</code></td>
                                    <td>If <code translate="no" class="notranslate">true</code> it logs all HTTP requests
and responses (it impacts performance)</td>
                                    <td><code translate="no" class="notranslate">false</code></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">endpoint</code></td>
                                    <td>Absolute URL to the SQS service</td>
                                    <td><a href="https://sqs.eu-west-1.amazonaws.com" class="reference external" rel="external noopener noreferrer" target="_blank">https://sqs.eu-west-1.amazonaws.com</a></td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">poll_timeout</code></td>
                                    <td>Wait for new message duration in
seconds</td>
                                    <td>0.1</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">queue_name</code></td>
                                    <td>Name of the queue</td>
                                    <td>messages</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">region</code></td>
                                    <td>Name of the AWS region</td>
                                    <td>eu-west-1</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">secret_key</code></td>
                                    <td>AWS secret key</td>
                                    <td>must be urlencoded</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">session_token</code></td>
                                    <td>AWS session token</td>
                                    <td>&nbsp;</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">visibility_timeout</code></td>
                                    <td>Amount of seconds the message will
not be visible (<a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-visibility-timeout.html" class="reference external" rel="external noopener noreferrer" target="_blank">Visibility Timeout</a>)</td>
                                    <td>Queue's configuration</td>
                            </tr>
                    <tr>
                                    <td><code translate="no" class="notranslate">wait_time</code></td>
                                    <td><a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-short-and-long-polling.html" class="reference external" rel="external noopener noreferrer" target="_blank">Long polling</a> duration in seconds</td>
                                    <td>20</td>
                            </tr>
            </tbody>
</table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.1</span>
    </p><p>The <code translate="no" class="notranslate">session_token</code> option was introduced in Symfony 6.1.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>The <code translate="no" class="notranslate">wait_time</code> parameter defines the maximum duration Amazon SQS should
wait until a message is available in a queue before sending a response.
It helps reducing the cost of using Amazon SQS by eliminating the number
of empty responses.</p>
<p>The <code translate="no" class="notranslate">poll_timeout</code> parameter defines the duration the receiver should wait
before returning null. It avoids blocking other receivers from being called.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>If the queue name is suffixed by <code translate="no" class="notranslate">.fifo</code>, AWS will create a <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html" class="reference external" rel="external noopener noreferrer" target="_blank">FIFO queue</a>.
Use the stamp <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Bridge/AmazonSqs/Transport/AmazonSqsFifoStamp.php" class="reference external" title="Symfony\Component\Messenger\Bridge\AmazonSqs\Transport\AmazonSqsFifoStamp" rel="external noopener noreferrer" target="_blank">AmazonSqsFifoStamp</a>
to define the <code translate="no" class="notranslate">Message group ID</code> and the <code translate="no" class="notranslate">Message deduplication ID</code>.</p>
<p>FIFO queues don't support setting a delay per message, a value of <code translate="no" class="notranslate">delay: 0</code>
is required in the retry strategy settings.</p>
</div>
</div>
<div class="section">
<h3 id="serializing-messages">
    Serializing Messages
    <a class="headerlink" href="#serializing-messages" title="Permalink to this headline">¶</a>
</h3>
<p>When messages are sent to (and received from) a transport, they're serialized
using PHP's native <code translate="no" class="notranslate">serialize()</code> &amp; <code translate="no" class="notranslate">unserialize()</code> functions. You can change
this globally (or for each transport) to a service that implements
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Transport/Serialization/SerializerInterface.php" class="reference external" title="Symfony\Component\Messenger\Transport\Serialization\SerializerInterface" rel="external noopener noreferrer" target="_blank">SerializerInterface</a>:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-0e51760b7405ee178a4d485f34399713603bfc15" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-0078fcb86492f4bbf310c0af63b1c8d947a1f1e9" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-ba5243bd0810a3bf73826a64546bdce04cca1a4b" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-0e51760b7405ee178a4d485f34399713603bfc15" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">serializer:</span>
            <span class="hljs-attr">default_serializer:</span> <span class="hljs-string">messenger.transport.symfony_serializer</span>
            <span class="hljs-attr">symfony_serializer:</span>
                <span class="hljs-attr">format:</span> <span class="hljs-string">json</span>
                <span class="hljs-attr">context:</span> <span class="hljs-string">{</span> <span class="hljs-string">}</span>

        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_normal:</span>
                <span class="hljs-attr">dsn:</span> <span class="hljs-comment"># ...</span>
                <span class="hljs-attr">serializer:</span> <span class="hljs-string">messenger.transport.symfony_serializer</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-0078fcb86492f4bbf310c0af63b1c8d947a1f1e9" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:serializer</span> <span class="hljs-attr">default-serializer</span>=<span class="hljs-string">"messenger.transport.symfony_serializer"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:symfony-serializer</span> <span class="hljs-attr">format</span>=<span class="hljs-string">"json"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">framework:context</span>/&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">framework:symfony-serializer</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:serializer</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_normal"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"..."</span> <span class="hljs-attr">serializer</span>=<span class="hljs-string">"messenger.transport.symfony_serializer"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-ba5243bd0810a3bf73826a64546bdce04cca1a4b" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>serializer()
        <span class="hljs-operator">-&gt;</span>defaultSerializer(<span class="hljs-string">'messenger.transport.symfony_serializer'</span>)
        <span class="hljs-operator">-&gt;</span>symfonySerializer()
            <span class="hljs-operator">-&gt;</span>format(<span class="hljs-string">'json'</span>)
            <span class="hljs-operator">-&gt;</span>context(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>);

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_normal'</span>)
        <span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'...'</span>)
        <span class="hljs-operator">-&gt;</span>serializer(<span class="hljs-string">'messenger.transport.symfony_serializer'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>The <code translate="no" class="notranslate">messenger.transport.symfony_serializer</code> is a built-in service that uses
the <a href="serializer.html" class="reference internal">Serializer component</a> and can be configured in a few ways.
If you <em>do</em> choose to use the Symfony serializer, you can control the context
on a case-by-case basis via the <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Stamp/SerializerStamp.php" class="reference external" title="Symfony\Component\Messenger\Stamp\SerializerStamp" rel="external noopener noreferrer" target="_blank">SerializerStamp</a>
(see <a href="messenger.html#envelopes-stamps" class="reference internal">Envelopes &amp; Stamps</a>).</p>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>When sending/receiving messages to/from another application, you may need
more control over the serialization process. Using a custom serializer
provides that control. See <a href="https://symfonycasts.com/screencast/messenger/transport-serializer" class="reference external" rel="external noopener noreferrer" target="_blank">SymfonyCasts' message serializer tutorial</a> for
details.</p>
</div>
</div>
</div>
<div class="section">
<h2 id="customizing-handlers">
    Customizing Handlers
    <a class="headerlink" href="#customizing-handlers" title="Permalink to this headline">¶</a>
</h2>
<div class="section">
<h3 id="configuring-handlers-using-attributes">
    Configuring Handlers Using Attributes
    <a class="headerlink" href="#configuring-handlers-using-attributes" title="Permalink to this headline">¶</a>
</h3>
<p>You can configure your handler by passing options to the attribute:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/SmsNotificationHandler.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">OtherSmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">SmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Attribute</span>\<span class="hljs-title">AsMessageHandler</span>;

<span class="hljs-comment">#[AsMessageHandler(fromTransport: 'async', priority: 10)]</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsNotificationHandler</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(SmsNotification <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>)</span>
    </span>{
        <span class="hljs-comment">// ...</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Possible options to configure with the attribute are:</p>
<ul>
    <li><code translate="no" class="notranslate">bus</code></li>
<li><code translate="no" class="notranslate">fromTransport</code></li>
<li><code translate="no" class="notranslate">handles</code></li>
<li><code translate="no" class="notranslate">method</code></li>
<li><code translate="no" class="notranslate">priority</code></li>
</ul>
<span id="messenger-handler-config"></span>
</div>
<div class="section">
<h3 id="manually-configuring-handlers">
    Manually Configuring Handlers
    <a class="headerlink" href="#manually-configuring-handlers" title="Permalink to this headline">¶</a>
</h3>
<p>Symfony will normally <a href="messenger.html#messenger-handler" class="reference internal">find and register your handler automatically</a>.
But, you can also configure a handler manually - and pass it some extra config -
by tagging the handler service with <code translate="no" class="notranslate">messenger.message_handler</code></p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-653417f775cdd1d8089ee3e57bba2c03d470fdf8" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-4e127dbc08ad781a54500119b3b4c69b05d1f929" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-d87817aad65c13ec867383c23347ba27cc603999" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-653417f775cdd1d8089ee3e57bba2c03d470fdf8" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/services.yaml</span>
<span class="hljs-attr">services:</span>
    <span class="hljs-string">App\MessageHandler\SmsNotificationHandler:</span>
        <span class="hljs-attr">tags:</span> <span class="hljs-string">[messenger.message_handler]</span>

        <span class="hljs-comment"># or configure with options</span>
        <span class="hljs-attr">tags:</span>
            <span class="hljs-bullet">-</span>
                <span class="hljs-attr">name:</span> <span class="hljs-string">messenger.message_handler</span>
                <span class="hljs-comment"># only needed if can't be guessed by type-hint</span>
                <span class="hljs-attr">handles:</span> <span class="hljs-string">App\Message\SmsNotification</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-4e127dbc08ad781a54500119b3b4c69b05d1f929" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/services.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">services</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"App\MessageHandler\SmsNotificationHandler"</span>&gt;</span>
             <span class="hljs-comment">&lt;!-- handles is only needed if it can't be guessed by type-hint --&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">tag</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"messenger.message_handler"</span>
                  <span class="hljs-attr">handles</span>=<span class="hljs-string">"App\Message\SmsNotification"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">services</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-d87817aad65c13ec867383c23347ba27cc603999" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/services.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">SmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>\<span class="hljs-title">SmsNotificationHandler</span>;

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>container</span><span class="hljs-operator">-&gt;</span>register(SmsNotificationHandler<span class="hljs-operator">::</span>class)
    <span class="hljs-operator">-&gt;</span>addTag(<span class="hljs-string">'messenger.message_handler'</span>, [
        <span class="hljs-comment">// only needed if can't be guessed by type-hint</span>
        <span class="hljs-string">'handles'</span> =&gt; SmsNotification<span class="hljs-operator">::</span>class,
    ]);</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>Possible options to configure with tags are:</p>
<ul>
    <li><code translate="no" class="notranslate">bus</code></li>
<li><code translate="no" class="notranslate">from_transport</code></li>
<li><code translate="no" class="notranslate">handles</code></li>
<li><code translate="no" class="notranslate">method</code></li>
<li><code translate="no" class="notranslate">priority</code></li>
</ul>
<span id="handler-subscriber-options"></span>
</div>
<div class="section">
<h3 id="handling-multiple-messages">
    Handling Multiple Messages
    <a class="headerlink" href="#handling-multiple-messages" title="Permalink to this headline">¶</a>
</h3>
<p>A single handler class can handle multiple messages. For that add the
<code translate="no" class="notranslate">#AsMessageHandler</code> attribute to all the handling methods:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/SmsNotificationHandler.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">OtherSmsNotification</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">SmsNotification</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsNotificationHandler</span>
</span>{
    <span class="hljs-comment">#[AsMessageHandler]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleSmsNotification</span><span class="hljs-params">(SmsNotification <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>)</span>
    </span>{
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-comment">#[AsMessageHandler]</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleOtherSmsNotification</span><span class="hljs-params">(OtherSmsNotification <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>)</span>
    </span>{
        <span class="hljs-comment">// ...</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-deprecated ">
    <p class="admonition-title">
                                    <span>6.2</span>
    </p><p>Implementing the <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Handler/MessageSubscriberInterface.php" class="reference external" title="Symfony\Component\Messenger\Handler\MessageSubscriberInterface" rel="external noopener noreferrer" target="_blank">MessageSubscriberInterface</a>
is another way to handle multiple messages with one handler class. This
interface was deprecated in Symfony 6.2.</p>
</div>
</div>
<div class="section">
<h3 id="binding-handlers-to-different-transports">
    Binding Handlers to Different Transports
    <a class="headerlink" href="#binding-handlers-to-different-transports" title="Permalink to this headline">¶</a>
</h3>
<p>Each message can have multiple handlers, and when a message is consumed
<em>all</em> of its handlers are called. But you can also configure a handler to only
be called when it's received from a <em>specific</em> transport. This allows you to
have a single message where each handler is called by a different &quot;worker&quot;
that's consuming a different transport.</p>
<p>Suppose you have an <code translate="no" class="notranslate">UploadedImage</code> message with two handlers:</p>
<ul>
    <li><code translate="no" class="notranslate">ThumbnailUploadedImageHandler</code>: you want this to be handled by
a transport called <code translate="no" class="notranslate">image_transport</code></li>
<li><code translate="no" class="notranslate">NotifyAboutNewUploadedImageHandler</code>: you want this to be handled
by a transport called <code translate="no" class="notranslate">async_priority_normal</code></li>
</ul>
<p>To do this, add the <code translate="no" class="notranslate">from_transport</code> option to each handler. For example:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/ThumbnailUploadedImageHandler.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">MessageHandler</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Message</span>\<span class="hljs-title">UploadedImage</span>;

<span class="hljs-comment">#[AsMessageHandler(from_transport: 'image_transport')]</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThumbnailUploadedImageHandler</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(UploadedImage <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>uploadedImage</span>)</span>
    </span>{
        <span class="hljs-comment">// do some thumbnailing</span>
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>And similarly:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// src/MessageHandler/NotifyAboutNewUploadedImageHandler.php</span>
<span class="hljs-comment">// ...</span>

<span class="hljs-comment">#[AsMessageHandler(from_transport: 'async_priority_normal')]</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotifyAboutNewUploadedImageHandler</span>
</span>{
    <span class="hljs-comment">// ...</span>
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Then, make sure to &quot;route&quot; your message to <em>both</em> transports:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-dd4b1aa192a47ba26eacbc756580a25d2688b53c" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-ba78c496996472b826654ef99185c8295acff487" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-b76b82a161c10e2df91def752e630cb0c1b765ba" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-dd4b1aa192a47ba26eacbc756580a25d2688b53c" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">transports:</span>
            <span class="hljs-attr">async_priority_normal:</span> <span class="hljs-comment"># ...</span>
            <span class="hljs-attr">image_transport:</span> <span class="hljs-comment"># ...</span>

        <span class="hljs-attr">routing:</span>
            <span class="hljs-comment"># ...</span>
            <span class="hljs-string">'App\Message\UploadedImage'</span><span class="hljs-string">:</span> <span class="hljs-string">[image_transport,</span> <span class="hljs-string">async_priority_normal]</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-ba78c496996472b826654ef99185c8295acff487" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"async_priority_normal"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"..."</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:transport</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"image_transport"</span> <span class="hljs-attr">dsn</span>=<span class="hljs-string">"..."</span>/&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">framework:routing</span> <span class="hljs-attr">message-class</span>=<span class="hljs-string">"App\Message\UploadedImage"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"image_transport"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:sender</span> <span class="hljs-attr">service</span>=<span class="hljs-string">"async_priority_normal"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:routing</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-b76b82a161c10e2df91def752e630cb0c1b765ba" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'async_priority_normal'</span>)<span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'...'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>transport(<span class="hljs-string">'image_transport'</span>)<span class="hljs-operator">-&gt;</span>dsn(<span class="hljs-string">'...'</span>);

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>routing(<span class="hljs-string">'App\Message\UploadedImage'</span>)
        <span class="hljs-operator">-&gt;</span>senders([<span class="hljs-string">'image_transport'</span>, <span class="hljs-string">'async_priority_normal'</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<p>That's it! You can now consume each transport:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-comment"># will only call ThumbnailUploadedImageHandler when handling the message</span>
<span class="hljs-prompt">$ </span>php bin/console messenger:consume image_transport -vv

<span class="hljs-prompt">$ </span>php bin/console messenger:consume async_priority_normal -vv</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-caution ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Caution</span>
    </p><p>If a handler does <em>not</em> have <code translate="no" class="notranslate">from_transport</code> config, it will be executed
on <em>every</em> transport that the message is received from.</p>
</div>
</div>
<div class="section">
<h3 id="process-messages-by-batches">
    Process Messages by Batches
    <a class="headerlink" href="#process-messages-by-batches" title="Permalink to this headline">¶</a>
</h3>
<p>You can declare &quot;special&quot; handlers which will process messages by batch.
By doing so, the handler will wait for a certain amount of messages to be
pending before processing them. The declaration of a batch handler is done
by implementing
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Handler/BatchHandlerInterface.php" class="reference external" title="Symfony\Component\Messenger\Handler\BatchHandlerInterface" rel="external noopener noreferrer" target="_blank">BatchHandlerInterface</a>. The
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Handler/BatchHandlerTrait.php" class="reference external" title="Symfony\Component\Messenger\Handler\BatchHandlerTrait" rel="external noopener noreferrer" target="_blank">BatchHandlerTrait</a> is also
provided in order to ease the declaration of these special handlers:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">Acknowledger</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">BatchHandlerInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">BatchHandlerTrait</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBatchHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BatchHandlerInterface</span>
</span>{
    <span class="hljs-keyword">use</span> <span class="hljs-title">BatchHandlerTrait</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span><span class="hljs-params">(MyMessage <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>, Acknowledger <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>ack</span> = null)</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>handle(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>ack</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span><span class="hljs-params">(array <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>jobs</span>)</span>: <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>jobs</span> <span class="hljs-keyword">as</span> [<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>message</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>ack</span>]) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// Compute $result from $message...</span>

                <span class="hljs-comment">// Acknowledge the processing of the message</span>
                <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>ack</span><span class="hljs-operator">-&gt;</span>ack(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>result</span>);
            } <span class="hljs-keyword">catch</span> (\Throwable <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>e</span>) {
                <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>ack</span><span class="hljs-operator">-&gt;</span>nack(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>e</span>);
            }
        }
    }

    <span class="hljs-comment">// Optionally, you can either redefine the `shouldFlush()` method</span>
    <span class="hljs-comment">// of the trait to define your own batch size...</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldFlush</span><span class="hljs-params">()</span>: <span class="hljs-title">bool</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> &lt;= \count(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>jobs);
    }

    <span class="hljs-comment">// ... or redefine the `getBatchSize()` method if the default</span>
    <span class="hljs-comment">// flush behavior suits your needs</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBatchSize</span><span class="hljs-params">()</span>: <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.3</span>
    </p><p>The <a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Handler/BatchHandlerTrait.php#method_getBatchSize" class="reference external" title="Symfony\Component\Messenger\Handler\BatchHandlerTrait::getBatchSize()" rel="external noopener noreferrer" target="_blank">getBatchSize()</a>
method was introduced in Symfony 6.3.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>When the <code translate="no" class="notranslate">$ack</code> argument of <code translate="no" class="notranslate">__invoke()</code> is <code translate="no" class="notranslate">null</code>, the message is
expected to be handled synchronously. Otherwise, <code translate="no" class="notranslate">__invoke()</code> is
expected to return the number of pending messages. The
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Handler/BatchHandlerTrait.php" class="reference external" title="Symfony\Component\Messenger\Handler\BatchHandlerTrait" rel="external noopener noreferrer" target="_blank">BatchHandlerTrait</a> handles
this for you.</p>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>By default, pending batches are flushed when the worker is idle as well
as when it is stopped.</p>
</div>
</div>
</div>
<div class="section">
<h2 id="extending-messenger">
    Extending Messenger
    <a class="headerlink" href="#extending-messenger" title="Permalink to this headline">¶</a>
</h2>
<div class="section">
<h3 id="envelopes-stamps">
    Envelopes &amp; Stamps
    <a class="headerlink" href="#envelopes-stamps" title="Permalink to this headline">¶</a>
</h3>
<p>A message can be any PHP object. Sometimes, you may need to configure something
extra about the message - like the way it should be handled inside AMQP or adding
a delay before the message should be handled. You can do that by adding a &quot;stamp&quot;
to your message:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Envelope</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">MessageBusInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Messenger</span>\<span class="hljs-title">Stamp</span>\<span class="hljs-title">DelayStamp</span>;

<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(MessageBusInterface <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span>)</span>
</span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>dispatch(<span class="hljs-keyword">new</span> SmsNotification(<span class="hljs-string">'...'</span>), [
        <span class="hljs-comment">// wait 5 seconds before processing</span>
        <span class="hljs-keyword">new</span> DelayStamp(<span class="hljs-number">5000</span>),
    ]);

    <span class="hljs-comment">// or explicitly create an Envelope</span>
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>dispatch(<span class="hljs-keyword">new</span> Envelope(<span class="hljs-keyword">new</span> SmsNotification(<span class="hljs-string">'...'</span>), [
        <span class="hljs-keyword">new</span> DelayStamp(<span class="hljs-number">5000</span>),
    ]));

    <span class="hljs-comment">// ...</span>
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Internally, each message is wrapped in an <code translate="no" class="notranslate">Envelope</code>, which holds the message
and stamps. You can create this manually or allow the message bus to do it. There
are a variety of different stamps for different purposes and they're used internally
to track information about a message - like the message bus that's handling it
or if it's being retried after failure.</p>
</div>
<div class="section">
<h3 id="middleware">
    Middleware
    <a class="headerlink" href="#middleware" title="Permalink to this headline">¶</a>
</h3>
<p>What happens when you dispatch a message to a message bus depends on its
collection of middleware and their order. By default, the middleware configured
for each bus looks like this:</p>
<ol class="arabic">
    <li><code translate="no" class="notranslate">add_bus_name_stamp_middleware</code> - adds a stamp to record which bus this
message was dispatched into;</li>
<li><code translate="no" class="notranslate">dispatch_after_current_bus</code>- see <a href="messenger/dispatch_after_current_bus.html" class="reference internal">Transactional Messages: Handle New Messages After Handling is Done</a>;</li>
<li><code translate="no" class="notranslate">failed_message_processing_middleware</code> - processes messages that are being
retried via the <a href="messenger.html#messenger-failure-transport" class="reference internal">failure transport</a> to make
them properly function as if they were being received from their original transport;</li>
<li>Your own collection of <a href="messenger.html#middleware" class="reference internal">middleware</a>;</li>
<li><code translate="no" class="notranslate">send_message</code> - if routing is configured for the transport, this sends
messages to that transport and stops the middleware chain;</li>
<li><code translate="no" class="notranslate">handle_message</code> - calls the message handler(s) for the given message.</li>
</ol>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>These middleware names are actually shortcut names. The real service ids
are prefixed with <code translate="no" class="notranslate">messenger.middleware.</code> (e.g. <code translate="no" class="notranslate">messenger.middleware.handle_message</code>).</p>
</div>
<p>The middleware are executed when the message is dispatched but <em>also</em> again when
a message is received via the worker (for messages that were sent to a transport
to be handled asynchronously). Keep this in mind if you create your own middleware.</p>
<p>You can add your own middleware to this list, or completely disable the default
middleware and <em>only</em> include your own:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-c05b062cc8539d82559824a0d4f436589eddbe08" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-d792c4873cc8a8a876179eef8cd3e733fb48305c" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-562206959448315aed01ddea9732cbe6ed5a52e3" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-c05b062cc8539d82559824a0d4f436589eddbe08" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">buses:</span>
            <span class="hljs-attr">messenger.bus.default:</span>
                <span class="hljs-comment"># disable the default middleware</span>
                <span class="hljs-attr">default_middleware:</span> <span class="hljs-literal">false</span>

                <span class="hljs-comment"># and/or add your own</span>
                <span class="hljs-attr">middleware:</span>
                    <span class="hljs-comment"># service ids that implement Symfony\Component\Messenger\Middleware\MiddlewareInterface</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">'App\Middleware\MyMiddleware'</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">'App\Middleware\AnotherMiddleware'</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-d792c4873cc8a8a876179eef8cd3e733fb48305c" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- default-middleware: disable the default middleware --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:bus</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"messenger.bus.default"</span> <span class="hljs-attr">default-middleware</span>=<span class="hljs-string">"false"</span>/&gt;</span>

            <span class="hljs-comment">&lt;!-- and/or add your own --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"App\Middleware\MyMiddleware"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"App\Middleware\AnotherMiddleware"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-562206959448315aed01ddea9732cbe6ed5a52e3" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>bus(<span class="hljs-string">'messenger.bus.default'</span>)
        <span class="hljs-operator">-&gt;</span>defaultMiddleware(<span class="hljs-keyword">false</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'App\Middleware\MyMiddleware'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'App\Middleware\AnotherMiddleware'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>If a middleware service is abstract, a different instance of the service will
be created per bus.</p>
</div>
<span id="middleware-doctrine"></span>
</div>
<div class="section">
<h3 id="middleware-for-doctrine">
    Middleware for Doctrine
    <a class="headerlink" href="#middleware-for-doctrine" title="Permalink to this headline">¶</a>
</h3>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>1.11</span>
    </p><p>The following Doctrine middleware was introduced in DoctrineBundle 1.11.</p>
</div>
<p>If you use Doctrine in your app, a number of optional middleware exist that you
may want to use:</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-fa0911869260bcc15bf96adad30db7bb40a4ccab" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-6f7b619596f13441a3de157939afa0b73ae58a2a" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-5b6dde282628e6b02bb33aa1a1841d4d9c6efe7f" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-fa0911869260bcc15bf96adad30db7bb40a4ccab" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">buses:</span>
            <span class="hljs-attr">command_bus:</span>
                <span class="hljs-attr">middleware:</span>
                    <span class="hljs-comment"># each time a message is handled, the Doctrine connection</span>
                    <span class="hljs-comment"># is "pinged" and reconnected if it's closed. Useful</span>
                    <span class="hljs-comment"># if your workers run for a long time and the database</span>
                    <span class="hljs-comment"># connection is sometimes lost</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">doctrine_ping_connection</span>

                    <span class="hljs-comment"># After handling, the Doctrine connection is closed,</span>
                    <span class="hljs-comment"># which can free up database connections in a worker,</span>
                    <span class="hljs-comment"># instead of keeping them open forever</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">doctrine_close_connection</span>

                    <span class="hljs-comment"># wraps all handlers in a single Doctrine transaction</span>
                    <span class="hljs-comment"># handlers do not need to call flush() and an error</span>
                    <span class="hljs-comment"># in any handler will cause a rollback</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">doctrine_transaction</span>

                    <span class="hljs-comment"># or pass a different entity manager to any</span>
                    <span class="hljs-comment">#- doctrine_transaction: ['custom']</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-6f7b619596f13441a3de157939afa0b73ae58a2a" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:bus</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"command_bus"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"doctrine_transaction"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"doctrine_ping_connection"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"doctrine_close_connection"</span>/&gt;</span>

                <span class="hljs-comment">&lt;!-- or pass a different entity manager to any --&gt;</span>
                <span class="hljs-comment">&lt;!--
                &lt;framework:middleware id="doctrine_transaction"&gt;
                    &lt;framework:argument&gt;custom&lt;/framework:argument&gt;
                &lt;/framework:middleware&gt;
                --&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:bus</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-5b6dde282628e6b02bb33aa1a1841d4d9c6efe7f" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>bus(<span class="hljs-string">'command_bus'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'doctrine_transaction'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'doctrine_ping_connection'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'doctrine_close_connection'</span>);
    <span class="hljs-comment">// Using another entity manager</span>
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'doctrine_transaction'</span>)
        <span class="hljs-operator">-&gt;</span>arguments([<span class="hljs-string">'custom'</span>]);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
</div>
<div class="section">
<h3 id="other-middlewares">
    Other Middlewares
    <a class="headerlink" href="#other-middlewares" title="Permalink to this headline">¶</a>
</h3>
<p>Add the <code translate="no" class="notranslate">router_context</code> middleware if you need to generate absolute URLs in
the consumer (e.g. render a template with links). This middleware stores the
original request context (i.e. the host, the HTTP port, etc.) which is needed
when building absolute URLs.</p>
<p>Add the <code translate="no" class="notranslate">validation</code> middleware if you need to validate the message
object using the <a href="components/validator.html" class="reference internal">Validator component</a> before handling it.
If validation fails, a <code translate="no" class="notranslate">ValidationFailedException</code> will be thrown. The
<a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Stamp/ValidationStamp.php" class="reference external" title="Symfony\Component\Messenger\Stamp\ValidationStamp" rel="external noopener noreferrer" target="_blank">ValidationStamp</a> can be used
to configure the validation groups.</p>
<div class="configuration-block">
    <div role="tablist" aria-label="Configuration formats" class="configuration-tabs configuration-tabs-length-3">
                    <button role="tab" type="button" data-language="yaml"
                aria-controls="configuration-block-tabpanel-f453cb174053456b5b454e4ba455af7d7f1daa76" aria-selected="true"
                data-active="true" >
                <span>YAML</span>
            </button>
                    <button role="tab" type="button" data-language="xml"
                aria-controls="configuration-block-tabpanel-87a44988349ccb8f3cc0a2f9f966c23c25ea87b9" aria-selected="false"
                 tabindex="-1">
                <span>XML</span>
            </button>
                    <button role="tab" type="button" data-language="php"
                aria-controls="configuration-block-tabpanel-706664e192017d623508c29f8fbd8861cf445aeb" aria-selected="false"
                 tabindex="-1">
                <span>PHP</span>
            </button>
            </div>

            <div role="tabpanel" id="configuration-block-tabpanel-f453cb174053456b5b454e4ba455af7d7f1daa76" aria-label="YAML" class="configuration-codeblock" data-language="yaml" style="">
            <div translate="no" class="highlight-yaml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs yaml"><span class="hljs-comment"># config/packages/messenger.yaml</span>
<span class="hljs-attr">framework:</span>
    <span class="hljs-attr">messenger:</span>
        <span class="hljs-attr">buses:</span>
            <span class="hljs-attr">command_bus:</span>
                <span class="hljs-attr">middleware:</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">router_context</span>
                    <span class="hljs-bullet">-</span> <span class="hljs-string">validation</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-87a44988349ccb8f3cc0a2f9f966c23c25ea87b9" aria-label="XML" class="configuration-codeblock" data-language="xml" style="display: none">
            <div translate="no" class="highlight-xml notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs xml"><span class="hljs-comment">&lt;!-- config/packages/messenger.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services"</span>
    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hljs-attr">xmlns:framework</span>=<span class="hljs-string">"http://symfony.com/schema/dic/symfony"</span>
    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://symfony.com/schema/dic/services
        https://symfony.com/schema/dic/services/services-1.0.xsd
        http://symfony.com/schema/dic/symfony
        https://symfony.com/schema/dic/symfony/symfony-1.0.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">framework:config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">framework:messenger</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">framework:bus</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"command_bus"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"router_context"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">framework:middleware</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"validation"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">framework:bus</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">framework:messenger</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">framework:config</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span></pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
            <div role="tabpanel" id="configuration-block-tabpanel-706664e192017d623508c29f8fbd8861cf445aeb" aria-label="PHP" class="configuration-codeblock" data-language="php" style="display: none">
            <div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// config/packages/messenger.php</span>
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Config</span>\<span class="hljs-title">FrameworkConfig</span>;

<span class="hljs-keyword">return</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(FrameworkConfig <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>messenger();

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>messenger</span><span class="hljs-operator">-&gt;</span>bus(<span class="hljs-string">'command_bus'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'router_context'</span>);
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>bus</span><span class="hljs-operator">-&gt;</span>middleware()<span class="hljs-operator">-&gt;</span>id(<span class="hljs-string">'validation'</span>);
};</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
        </div>
    </div>
</div>
<div class="section">
<h3 id="messenger-events">
    Messenger Events
    <a class="headerlink" href="#messenger-events" title="Permalink to this headline">¶</a>
</h3>
<p>In addition to middleware, Messenger also dispatches several events. You can
<a href="event_dispatcher.html" class="reference internal">create an event listener</a> to hook into various parts
of the process. For each, the event class is the event name:</p>
<ul>
    <li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/SendMessageToTransportsEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\SendMessageToTransportsEvent" rel="external noopener noreferrer" target="_blank">SendMessageToTransportsEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerMessageFailedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerMessageFailedEvent" rel="external noopener noreferrer" target="_blank">WorkerMessageFailedEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerMessageHandledEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerMessageHandledEvent" rel="external noopener noreferrer" target="_blank">WorkerMessageHandledEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerMessageReceivedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerMessageReceivedEvent" rel="external noopener noreferrer" target="_blank">WorkerMessageReceivedEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerMessageRetriedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerMessageRetriedEvent" rel="external noopener noreferrer" target="_blank">WorkerMessageRetriedEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerRateLimitedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerRateLimitedEvent" rel="external noopener noreferrer" target="_blank">WorkerRateLimitedEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerRunningEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerRunningEvent" rel="external noopener noreferrer" target="_blank">WorkerRunningEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerStartedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerStartedEvent" rel="external noopener noreferrer" target="_blank">WorkerStartedEvent</a></li>
<li><a href="https://github.com/symfony/symfony/blob/5.4/src/Symfony/Component/Messenger/Event/WorkerStoppedEvent.php" class="reference external" title="Symfony\Component\Messenger\Event\WorkerStoppedEvent" rel="external noopener noreferrer" target="_blank">WorkerStoppedEvent</a></li>
</ul>
<div class="admonition admonition-versionadded ">
    <p class="admonition-title">
                                    <span>6.2</span>
    </p><p>The <code translate="no" class="notranslate">WorkerRateLimitedEvent</code> was introduced in Symfony 6.3.</p>
</div>
</div>
</div>
<div class="section">
<h2 id="multiple-buses-command-event-buses">
    Multiple Buses, Command &amp; Event Buses
    <a class="headerlink" href="#multiple-buses-command-event-buses" title="Permalink to this headline">¶</a>
</h2>
<p>Messenger gives you a single message bus service by default. But, you can configure
as many as you want, creating &quot;command&quot;, &quot;query&quot; or &quot;event&quot; buses and controlling
their middleware. See <a href="messenger/multiple_buses.html" class="reference internal">Multiple Buses</a>.</p>
</div>
<div class="section">
<h2 id="learn-more">
    Learn more
    <a class="headerlink" href="#learn-more" title="Permalink to this headline">¶</a>
</h2>
<div class="toctree-wrapper toc-size-md"><ul class="toctree toctree-level-1 toctree-length-4"><li><a href="messenger/custom-transport.html">How to Create Your own Messenger Transport</a></li><li><a href="messenger/dispatch_after_current_bus.html">Transactional Messages: Handle New Messages After Handling is Done</a></li><li><a href="messenger/handler_results.html">Getting Results from your Handler</a></li><li><a href="messenger/multiple_buses.html">Multiple Buses</a></li></ul></div>
</div>
</div>

                            </div>                    </div>
                                    </div>        </div>

    </section>

</div>


<script type="text/javascript" src="assets/js/theme.js"></script>
<script type="text/javascript" src="assets/js/badge_only.js"></script>

 
</body>
</html>