        
<!DOCTYPE html>
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head><base href="/">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            
                                
    
    <link rel="stylesheet" href="assets/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/highlightjs.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/badge_only.css" type="text/css" />

</head>

<body class="wy-body-for-nav">
 <div class="wy-grid-for-nav">

        <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">
                
                                                                                                    
                                                                                                                                                                        </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                                                                                                                                                                                                                                                                                                                            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

                                                        

        <div class="wy-nav-content">                <div class="rst-content">
                                        <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">                            <div itemprop="articleBody">
                                    <div class="section">
<h1 id="the-eventdispatcher-component">
    The EventDispatcher Component
    <a class="headerlink" href="#the-eventdispatcher-component" title="Permalink to this headline">Â¶</a>
</h1>
<p>Our framework is still missing a major characteristic of any good framework:
<em>extensibility</em>. Being extensible means that the developer should be able to
hook into the framework life cycle to modify the way the request is handled.</p>
<p>What kind of hooks are we talking about? Authentication or caching for
instance. To be flexible, hooks must be plug-and-play; the ones you &quot;register&quot;
for an application are different from the next one depending on your specific
needs. Many software have a similar concept like Drupal or WordPress. In some
languages, there is even a standard like <a href="https://www.python.org/dev/peps/pep-0333/#middleware-components-that-play-both-sides" class="reference external" rel="external noopener noreferrer" target="_blank">WSGI</a> in Python or <a href="https://github.com/rack/rack" class="reference external" rel="external noopener noreferrer" target="_blank">Rack</a> in Ruby.</p>
<p>As there is no standard for PHP, we are going to use a well-known design
pattern, the <em>Mediator</em>, to allow any kind of behaviors to be attached to our
framework; the Symfony EventDispatcher Component implements a lightweight
version of this pattern:</p>
<div translate="no" class="highlight-terminal highlight-bash notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs terminal bash"><span class="hljs-prompt">$ </span>composer require symfony/event-dispatcher</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>How does it work? The <em>dispatcher</em>, the central object of the event dispatcher
system, notifies <em>listeners</em> of an <em>event</em> dispatched to it. Put another way:
your code dispatches an event to the dispatcher, the dispatcher notifies all
registered listeners for the event, and each listener does whatever it wants
with the event.</p>
<p>As an example, let's create a listener that transparently adds the Google
Analytics code to all responses.</p>
<p>To make it work, the framework must dispatch an event just before returning
the Response instance:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/Framework.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">EventDispatcher</span>\<span class="hljs-title">EventDispatcher</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpKernel</span>\<span class="hljs-title">Controller</span>\<span class="hljs-title">ArgumentResolverInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpKernel</span>\<span class="hljs-title">Controller</span>\<span class="hljs-title">ControllerResolverInterface</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Routing</span>\<span class="hljs-title">Exception</span>\<span class="hljs-title">ResourceNotFoundException</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Routing</span>\<span class="hljs-title">Matcher</span>\<span class="hljs-title">UrlMatcherInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Framework</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        private EventDispatcher <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span>,
        private UrlMatcherInterface <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>matcher</span>,
        private ControllerResolverInterface <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controllerResolver</span>,
        private ArgumentResolverInterface <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>argumentResolver</span>,
    )</span> </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span><span class="hljs-params">(Request <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>)</span>
    </span>{
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>matcher<span class="hljs-operator">-&gt;</span>getContext()<span class="hljs-operator">-&gt;</span>fromRequest(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span><span class="hljs-operator">-&gt;</span>attributes<span class="hljs-operator">-&gt;</span>add(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>matcher<span class="hljs-operator">-&gt;</span>match(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span><span class="hljs-operator">-&gt;</span>getPathInfo()));

            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controller</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>controllerResolver<span class="hljs-operator">-&gt;</span>getController(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>);
            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>arguments</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>argumentResolver<span class="hljs-operator">-&gt;</span>getArguments(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controller</span>);

            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = call_user_func_array(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controller</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>arguments</span>);
        } <span class="hljs-keyword">catch</span> (ResourceNotFoundException <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>exception</span>) {
            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-keyword">new</span> Response(<span class="hljs-string">'Not Found'</span>, <span class="hljs-number">404</span>);
        } <span class="hljs-keyword">catch</span> (\<span class="hljs-keyword">Exception</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>exception</span>) {
            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-keyword">new</span> Response(<span class="hljs-string">'An error occurred'</span>, <span class="hljs-number">500</span>);
        }

        <span class="hljs-comment">// dispatch a response event</span>
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>dispatcher<span class="hljs-operator">-&gt;</span>dispatch(<span class="hljs-keyword">new</span> ResponseEvent(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>), <span class="hljs-string">'response'</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span>;
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Each time the framework handles a Request, a <code translate="no" class="notranslate">ResponseEvent</code> event is
now dispatched:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/ResponseEvent.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">EventDispatcher</span>\<span class="hljs-title">Event</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponseEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Event</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(
        private Response <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span>,
        private Request <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>,
    )</span> </span>{
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getResponse</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>response;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequest</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>this</span><span class="hljs-operator">-&gt;</span>request;
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>The last step is the creation of the dispatcher in the front controller and
the registration of a listener for the <code translate="no" class="notranslate">response</code> event:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/web/front.php</span>
<span class="hljs-keyword">require_once</span> <span class="hljs-keyword">__DIR__</span>.<span class="hljs-string">'/../vendor/autoload.php'</span>;

<span class="hljs-comment">// ...</span>

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">EventDispatcher</span>\<span class="hljs-title">EventDispatcher</span>;

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span> = <span class="hljs-keyword">new</span> EventDispatcher();
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addListener(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Simplex\ResponseEvent <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getResponse();

    <span class="hljs-keyword">if</span> (<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>isRedirection()
        || (<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers<span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Content-Type'</span>) &amp;&amp; <span class="hljs-keyword">false</span> === strpos(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers<span class="hljs-operator">-&gt;</span>get(<span class="hljs-string">'Content-Type'</span>), <span class="hljs-string">'html'</span>))
        || <span class="hljs-string">'html'</span> !== <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getRequest()<span class="hljs-operator">-&gt;</span>getRequestFormat()
    ) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>setContent(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>getContent().<span class="hljs-string">'GA CODE'</span>);
});

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controllerResolver</span> = <span class="hljs-keyword">new</span> ControllerResolver();
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>argumentResolver</span> = <span class="hljs-keyword">new</span> ArgumentResolver();

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span> = <span class="hljs-keyword">new</span> Simplex\Framework(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>matcher</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>controllerResolver</span>, <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>argumentResolver</span>);
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>framework</span><span class="hljs-operator">-&gt;</span>handle(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>request</span>);

<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>send();</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-note ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                <span>Note</span>
    </p><p>The listener is just a proof of concept and you should add the Google
Analytics code just before the body tag.</p>
</div>
<p>As you can see, <code translate="no" class="notranslate">addListener()</code> associates a valid PHP callback to a named
event (<code translate="no" class="notranslate">response</code>); the event name must be the same as the one used in the
<code translate="no" class="notranslate">dispatch()</code> call.</p>
<p>In the listener, we add the Google Analytics code only if the response is not
a redirection, if the requested format is HTML and if the response content
type is HTML (these conditions demonstrate the ease of manipulating the
Request and Response data from your code).</p>
<p>So far so good, but let's add another listener on the same event. Let's say
that we want to set the <code translate="no" class="notranslate">Content-Length</code> of the Response if it is not already
set:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addListener(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Simplex\ResponseEvent <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getResponse();
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers;

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Content-Length'</span>) &amp;&amp; !<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Transfer-Encoding'</span>)) {
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>set(<span class="hljs-string">'Content-Length'</span>, strlen(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>getContent()));
    }
});</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Depending on whether you have added this piece of code before the previous
listener registration or after it, you will have the wrong or the right value
for the <code translate="no" class="notranslate">Content-Length</code> header. Sometimes, the order of the listeners
matter but by default, all listeners are registered with the same priority,
<code translate="no" class="notranslate">0</code>. To tell the dispatcher to run a listener early, change the priority to
a positive number; negative numbers can be used for low priority listeners.
Here, we want the <code translate="no" class="notranslate">Content-Length</code> listener to be executed last, so change
the priority to <code translate="no" class="notranslate">-255</code>:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addListener(<span class="hljs-string">'response'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Simplex\ResponseEvent <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span>)</span> </span>{
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getResponse();
    <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers;

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Content-Length'</span>) &amp;&amp; !<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Transfer-Encoding'</span>)) {
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>set(<span class="hljs-string">'Content-Length'</span>, strlen(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>getContent()));
    }
}, <span class="hljs-number">-255</span>);</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>When creating your framework, think about priorities (reserve some numbers
for internal listeners for instance) and document them thoroughly.</p>
</div>
<p>Let's refactor the code a bit by moving the Google listener to its own class:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/GoogleListener.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoogleListener</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(ResponseEvent <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span>)</span>
    </span>{
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getResponse();

        <span class="hljs-keyword">if</span> (<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>isRedirection()
            || (<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers<span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Content-Type'</span>) &amp;&amp; <span class="hljs-keyword">false</span> === strpos(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers<span class="hljs-operator">-&gt;</span>get(<span class="hljs-string">'Content-Type'</span>), <span class="hljs-string">'html'</span>))
            || <span class="hljs-string">'html'</span> !== <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getRequest()<span class="hljs-operator">-&gt;</span>getRequestFormat()
        ) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>setContent(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>getContent().<span class="hljs-string">'GA CODE'</span>);
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>And do the same with the other listener:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/ContentLengthListener.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContentLengthListener</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(ResponseEvent <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span>)</span>
    </span>{
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>event</span><span class="hljs-operator">-&gt;</span>getResponse();
        <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span> = <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>headers;

        <span class="hljs-keyword">if</span> (!<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Content-Length'</span>) &amp;&amp; !<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>has(<span class="hljs-string">'Transfer-Encoding'</span>)) {
            <span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>headers</span><span class="hljs-operator">-&gt;</span>set(<span class="hljs-string">'Content-Length'</span>, strlen(<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>response</span><span class="hljs-operator">-&gt;</span>getContent()));
        }
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Our front controller should now look like the following:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span> = <span class="hljs-keyword">new</span> EventDispatcher();
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addListener(<span class="hljs-string">'response'</span>, [<span class="hljs-keyword">new</span> Simplex\ContentLengthListener(), <span class="hljs-string">'onResponse'</span>], <span class="hljs-number">-255</span>);
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addListener(<span class="hljs-string">'response'</span>, [<span class="hljs-keyword">new</span> Simplex\GoogleListener(), <span class="hljs-string">'onResponse'</span>]);</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>Even if the code is now nicely wrapped in classes, there is still a slight
issue: the knowledge of the priorities is &quot;hardcoded&quot; in the front controller,
instead of being in the listeners themselves. For each application, you have
to remember to set the appropriate priorities. Moreover, the listener method
names are also exposed here, which means that refactoring our listeners would
mean changing all the applications that rely on those listeners. The solution
to this dilemma is to use subscribers instead of listeners:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span> = <span class="hljs-keyword">new</span> EventDispatcher();
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addSubscriber(<span class="hljs-keyword">new</span> Simplex\ContentLengthListener());
<span class="hljs-variable"><span class="hljs-variable-other-marker">$</span>dispatcher</span><span class="hljs-operator">-&gt;</span>addSubscriber(<span class="hljs-keyword">new</span> Simplex\GoogleListener());</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>A subscriber knows about all the events it is interested in and pass this
information to the dispatcher via the <code translate="no" class="notranslate">getSubscribedEvents()</code> method. Have a
look at the new version of the <code translate="no" class="notranslate">GoogleListener</code>:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/GoogleListener.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">EventDispatcher</span>\<span class="hljs-title">EventSubscriberInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoogleListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">EventSubscriberInterface</span>
</span>{
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSubscribedEvents</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'response'</span> =&gt; <span class="hljs-string">'onResponse'</span>];
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<p>And here is the new version of <code translate="no" class="notranslate">ContentLengthListener</code>:</p>
<div translate="no" class="highlight-php notranslate">
    <table class="highlighttable">
        <tbody>
            <tr>
                <td class="linenos">
                    <div class="linenodiv">
                        <pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14</pre>
                    </div>
                </td>
                <td class="code">
                    <div class="highlight">
                        <pre class="hljs php"><span class="hljs-comment">// example.com/src/Simplex/ContentLengthListener.php</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title">Simplex</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">EventDispatcher</span>\<span class="hljs-title">EventSubscriberInterface</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ContentLengthListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">EventSubscriberInterface</span>
</span>{
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSubscribedEvents</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> [<span class="hljs-string">'response'</span> =&gt; [<span class="hljs-string">'onResponse'</span>, <span class="hljs-number">-255</span>]];
    }
}</pre>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<div class="admonition admonition-tip ">
    <p class="admonition-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                <span>Tip</span>
    </p><p>A single subscriber can host as many listeners as you want on as many
events as needed.</p>
</div>
<p>To make your framework truly flexible, don't hesitate to add more events; and
to make it more awesome out of the box, add more listeners. Again, this book
is not about creating a generic framework, but one that is tailored to your
needs. Stop whenever you see fit, and further evolve the code from there.</p>
</div>

                            </div>                    </div>
                                    </div>        </div>

    </section>

</div>


<script type="text/javascript" src="assets/js/theme.js"></script>
<script type="text/javascript" src="assets/js/badge_only.js"></script>

 
</body>
</html>